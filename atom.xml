<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Unshell&#39;s Blog</title>
  
  <subtitle>我相信所有坚韧不拔的努力，迟早会得来好报酬。</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="https://unshell.github.io/"/>
  <updated>2020-06-12T10:33:44.349Z</updated>
  <id>https://unshell.github.io/</id>
  
  <author>
    <name>Unshell</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>CentOs 安装 Redis</title>
    <link href="https://unshell.github.io/2020/06/12/CentOs%E5%AE%89%E8%A3%85Redis/"/>
    <id>https://unshell.github.io/2020/06/12/CentOs%E5%AE%89%E8%A3%85Redis/</id>
    <published>2020-06-12T09:10:59.000Z</published>
    <updated>2020-06-12T10:33:44.349Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><p>系统：CentOS Linux release 8.1.1911 (Core) | Redis版本：6.0.5 | 博客记录时间：2020-6-12 17:15:04</p><h3 id="下载最新稳定版"><a href="#下载最新稳定版" class="headerlink" title="下载最新稳定版"></a>下载最新稳定版</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 下载当前最新版</span></span><br><span class="line">wget http://download.redis.io/releases/redis-6.0.5.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 解压</span></span><br><span class="line">tar -zxvf redis-6.0.5.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入到解压后的文件夹</span></span><br><span class="line">cd redis-6.0.5</span><br></pre></td></tr></table></figure><h3 id="安装-Redis"><a href="#安装-Redis" class="headerlink" title="安装 Redis"></a>安装 Redis</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 编译前先确保安装了gcc和make</span></span><br><span class="line">yum install -y gcc make</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译(当前位置在redis-6.0.5中)</span></span><br><span class="line">make</span><br><span class="line"><span class="meta">#</span><span class="bash"> 编译结果如下：</span></span><br><span class="line">一堆的CC编译</span><br><span class="line">    LINK redis-server</span><br><span class="line">    INSTALL redis-sentinel</span><br><span class="line">    LINK redis-cli</span><br><span class="line">    LINK redis-benchmark</span><br><span class="line">    INSTALL redis-check-rdb</span><br><span class="line">    INSTALL redis-check-aof</span><br><span class="line"></span><br><span class="line">Hint: It's a good idea to run 'make test' ;)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入到src目录</span></span><br><span class="line">cd src</span><br><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">make install</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出内容如下：</span></span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line">    INSTALL install</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行redis-server</span></span><br><span class="line">redis-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出内容如下说明，安装成功：</span></span><br><span class="line">7303:C 12 Jun 2020 17:59:37.751 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span><br><span class="line">7303:C 12 Jun 2020 17:59:37.751 # Redis version=6.0.5, bits=64, commit=00000000, modified=0, pid=7303, just started</span><br><span class="line">7303:C 12 Jun 2020 17:59:37.751 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.751 * Increased maximum number of open files to 10032 (it was originally set to 1024).</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-``__ ''-._                                             </span><br><span class="line">      _.-``    `.  `_.  ''-._           Redis 6.0.5 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ ''-._                                   </span><br><span class="line"> (    '      ,       .-`  | `,    )     Running in standalone mode</span><br><span class="line"> |`-._`-...-` __...-.``-._|'` _.-'|     Port: 6379</span><br><span class="line"> |    `-._   `._    /     _.-'    |     PID: 7303</span><br><span class="line">  `-._    `-._  `-./  _.-'    _.-'                                   </span><br><span class="line"> |`-._`-._    `-.__.-'    _.-'_.-'|                                  </span><br><span class="line"> |    `-._`-._        _.-'_.-'    |           http://redis.io        </span><br><span class="line">  `-._    `-._`-.__.-'_.-'    _.-'                                   </span><br><span class="line"> |`-._`-._    `-.__.-'    _.-'_.-'|                                  </span><br><span class="line"> |    `-._`-._        _.-'_.-'    |                                  </span><br><span class="line">  `-._    `-._`-.__.-'_.-'    _.-'                                   </span><br><span class="line">      `-._    `-.__.-'    _.-'                                       </span><br><span class="line">          `-._        _.-'                                           </span><br><span class="line">              `-.__.-'                                               </span><br><span class="line"></span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 # Server initialized</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 * Loading RDB produced by version 6.0.5</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 * RDB age 885 seconds</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 * RDB memory usage when created 0.77 Mb</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 * DB loaded from disk: 0.000 seconds</span><br><span class="line">7303:M 12 Jun 2020 17:59:37.752 * Ready to accept connections</span><br></pre></td></tr></table></figure><h3 id="配置-Redis"><a href="#配置-Redis" class="headerlink" title="配置 Redis"></a>配置 Redis</h3><p>在初次接触前我们尤其要注意三个文件：</p><ul><li>redis-6.0.5<ul><li>redis.conf  <code>(配置文件)</code></li><li>src<ul><li>redis-server <code>(Redis 服务)</code></li><li>redis-cli <code>(Redis 客户端)</code></li></ul></li></ul></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 用 vim 打开 redis-cli</span></span><br><span class="line">vim redis-cli</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启守护进程：</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> By default Redis does not run as a daemon. Use <span class="string">'yes'</span> <span class="keyword">if</span> you need it.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Note that Redis will write a pid file <span class="keyword">in</span> /var/run/redis.pid when daemonized.</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> 允许任何网络接口连接</span></span><br><span class="line">bind 127.0.0.1 修改为 bind 0.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 连接密码授权</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> IMPORTANT NOTE: starting with Redis 6 <span class="string">"requirepass"</span> is just a compatiblity</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> layer on top of the new ACL system. The option effect will be just setting</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the password <span class="keyword">for</span> the default user. Clients will still authenticate using</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> AUTH &lt;password&gt; as usually, or more explicitly with AUTH default &lt;password&gt;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> they follow the new protocol: both will work.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line">requirepass [你的密码]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当然除了在配置中设置密码，你还可以在客户端设置密码</span></span><br><span class="line">config set requirepass [你的密码]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其他的一些配置,如修改默认端口(6379)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Accept connections on the specified port, default is 6379 (IANA <span class="comment">#815344).</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> If port 0 is specified Redis will not listen on a TCP socket.</span></span><br><span class="line">port 6379</span><br></pre></td></tr></table></figure><h3 id="运行-Redis-服务"><a href="#运行-Redis-服务" class="headerlink" title="运行 Redis 服务"></a>运行 Redis 服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 配置相应的配置之后(包括开启守护进程),通过配置运行服务</span></span><br><span class="line">redis-server ../redis.conf</span><br></pre></td></tr></table></figure><h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><ul><li><a href="http://download.redis.io/releases/" target="_blank" rel="noopener">Redis Archived Versions</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;安装环境&quot;&gt;&lt;a href=&quot;#安装环境&quot; class=&quot;headerlink&quot; title=&quot;安装环境&quot;&gt;&lt;/a&gt;安装环境&lt;/h2&gt;&lt;p&gt;系统：CentOS Linux release 8.1.1911 (Core) | Redis版本：6.0.5 | 博客记录
      
    
    </summary>
    
    
    
      <category term="linux" scheme="https://unshell.github.io/tags/linux/"/>
    
      <category term="redis" scheme="https://unshell.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat 部署项目时遇到的问题</title>
    <link href="https://unshell.github.io/2020/04/23/Tomcat%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <id>https://unshell.github.io/2020/04/23/Tomcat%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</id>
    <published>2020-04-23T09:23:19.000Z</published>
    <updated>2020-04-23T09:50:45.068Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-org-apache-catalina-webresources-Cache-getResource-Unable-to-add-the-resource"><a href="#1-org-apache-catalina-webresources-Cache-getResource-Unable-to-add-the-resource" class="headerlink" title="1.org.apache.catalina.webresources.Cache.getResource Unable to add the resource"></a>1.org.apache.catalina.webresources.Cache.getResource Unable to add the resource</h3><p><strong>原因：</strong>资源缓存空间不足，得配置更大的资源缓存空间</p><p><strong>解决方法：</strong>修改 Tomcat 文件夹下 conf 文件中的 context.xml 文件，添加内容如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Resources</span> <span class="attr">cachingAllowed</span>=<span class="string">"true"</span> <span class="attr">cacheMaxSize</span>=<span class="string">"150000"</span> &gt;</span><span class="tag">&lt;/<span class="name">Resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="2-org-apache-catalina-core-NamingContextListener-lifecycleEvent-naming-namingContextCreationFailed"><a href="#2-org-apache-catalina-core-NamingContextListener-lifecycleEvent-naming-namingContextCreationFailed" class="headerlink" title="2.org.apache.catalina.core.NamingContextListener.lifecycleEvent naming.namingContextCreationFailed"></a>2.org.apache.catalina.core.NamingContextListener.lifecycleEvent naming.namingContextCreationFailed</h3><p><strong>原因</strong>：命名监听器创建失败</p><h3 id="3-org-apache-jasper-servlet-TldScanner-scanJars-至少有一个JAR被扫描用于TLD但尚未包含TLD。-为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。-在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。"><a href="#3-org-apache-jasper-servlet-TldScanner-scanJars-至少有一个JAR被扫描用于TLD但尚未包含TLD。-为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。-在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。" class="headerlink" title="3.org.apache.jasper.servlet.TldScanner.scanJars 至少有一个JAR被扫描用于TLD但尚未包含TLD。 为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。 在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。"></a>3.org.apache.jasper.servlet.TldScanner.scanJars 至少有一个JAR被扫描用于TLD但尚未包含TLD。 为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。 在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。</h3><p><strong>等级：</strong>警告</p><p><strong>解决方法:</strong></p><p><strong>1.修改 Tomcat 文件夹下 conf 文件夹中 logging.properties 文件</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出被扫描TLD的Jar包的列表</span></span><br><span class="line"><span class="meta">org.apache.jasper.servlet.TldScanner.level</span> = <span class="string">FINE</span></span><br></pre></td></tr></table></figure><p><strong>2.重新运行 Tomcat ，日志输出扫描的Jar包</strong></p><p><strong>3.修改 Tomcat 文件夹下 conf 文件夹中 catalina.properties 文件</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default list of JAR files that should not be scanned using the JarScanner</span></span><br><span class="line"><span class="comment"># functionality. This is typically used to scan JARs for configuration</span></span><br><span class="line"><span class="comment"># information. JARs that do not contain such information may be excluded from</span></span><br><span class="line"><span class="comment"># the scan to speed up the scanning process. This is the default list. JARs on</span></span><br><span class="line"><span class="comment"># this list are excluded from all scans. The list must be a comma separated list</span></span><br><span class="line"><span class="comment"># of JAR file names.</span></span><br><span class="line"><span class="comment"># The list of JARs to skip may be over-ridden at a Context level for individual</span></span><br><span class="line"><span class="comment"># scan types by configuring a JarScanner with a nested JarScanFilter.</span></span><br><span class="line"><span class="comment"># The JARs listed below include:</span></span><br><span class="line"><span class="comment"># - Tomcat Bootstrap JARs</span></span><br><span class="line"><span class="comment"># - Tomcat API JARs</span></span><br><span class="line"><span class="comment"># - Catalina JARs</span></span><br><span class="line"><span class="comment"># - Jasper JARs</span></span><br><span class="line"><span class="comment"># - Tomcat JARs</span></span><br><span class="line"><span class="comment"># - Common non-Tomcat JARs</span></span><br><span class="line"><span class="comment"># - Test JARs (JUnit, Cobertura and dependencies)</span></span><br><span class="line"><span class="meta">tomcat.util.scan.StandardJarScanFilter.jarsToSkip</span>=<span class="string">\</span></span><br><span class="line">annotations-api.jar,\ant-junit*.jar,\ant-launcher.jar,\</span><br><span class="line">ant.jar,\asm-*.jar,\aspectj*.jar,\bootstrap.jar,\catalina-ant.jar,\catalina-ha.jar,\</span><br><span class="line">catalina-ssi.jar,\catalina-storeconfig.jar,\catalina-tribes.jar,\catalina.jar,\cglib-*.jar,\</span><br><span class="line">cobertura-*.jar,\commons-beanutils*.jar,\commons-codec*.jar,\commons-collections*.jar,\</span><br><span class="line">commons-daemon.jar,\commons-dbcp*.jar,\commons-digester*.jar,\</span><br><span class="line">commons-fileupload*.jar,\commons-httpclient*.jar,\commons-io*.jar,\commons-lang*.jar,\</span><br><span class="line">commons-logging*.jar,\commons-math*.jar,\commons-pool*.jar,\dom4j-*.jar,\easymock-*.jar,\</span><br><span class="line">ecj-*.jar,\el-api.jar,\geronimo-spec-jaxrpc*.jar,\h2*.jar,\hamcrest-*.jar,\hibernate*.jar,\</span><br><span class="line">httpclient*.jar,\icu4j-*.jar,\jasper-el.jar,\jasper.jar,\jaspic-api.jar,\jaxb-*.jar,\</span><br><span class="line">jaxen-*.jar,\jdom-*.jar,\jetty-*.jar,\jmx-tools.jar,\jmx.jar,\jsp-api.jar,\jstl.jar,\</span><br><span class="line">jta*.jar,\junit-*.jar,\junit.jar,\log4j*.jar,\mail*.jar,\objenesis-*.jar,\oraclepki.jar,\</span><br><span class="line">oro-*.jar,\servlet-api-*.jar,\servlet-api.jar,\slf4j*.jar,\taglibs-standard-spec-*.jar,\</span><br><span class="line">tagsoup-*.jar,\tomcat-api.jar,\tomcat-coyote.jar,\tomcat-dbcp.jar,\tomcat-i18n-*.jar,\</span><br><span class="line">tomcat-jdbc.jar,\tomcat-jni.jar,\tomcat-juli-adapters.jar,\tomcat-juli.jar,\tomcat-util-scan.jar,\</span><br><span class="line">tomcat-util.jar,\tomcat-websocket.jar,\tools.jar,\websocket-api.jar,\wsdl4j*.jar,\xercesImpl.jar,\</span><br><span class="line"><span class="attr">xml-apis.jar,\xmlParserAPIs-*.jar,\xmlParserAPIs.jar,\xom-*.jar</span></span><br><span class="line"><span class="comment"># 将要跳过扫描的包在后面添加</span></span><br><span class="line"><span class="comment"># 例子：mysql-connector-*.jar,\</span></span><br><span class="line"><span class="comment"># 注意以 ,\ 分隔</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;1-org-apache-catalina-webresources-Cache-getResource-Unable-to-add-the-resource&quot;&gt;&lt;a href=&quot;#1-org-apache-catalina-webresources-Cache-
      
    
    </summary>
    
    
    
      <category term="tomcat" scheme="https://unshell.github.io/tags/tomcat/"/>
    
      <category term="bug" scheme="https://unshell.github.io/tags/bug/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat 服务</title>
    <link href="https://unshell.github.io/2020/04/23/Tomcat%E6%9C%8D%E5%8A%A1/"/>
    <id>https://unshell.github.io/2020/04/23/Tomcat%E6%9C%8D%E5%8A%A1/</id>
    <published>2020-04-23T04:22:00.000Z</published>
    <updated>2020-06-12T09:10:17.815Z</updated>
    
    <content type="html"><![CDATA[<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>运行环境：Windows 10 | Apache Tomcat 9.0.34 | 博客记录时间：2020-4-23 17:16:12</p><p>通常我们 打开 / 关闭 Tomcat 服务时都会执行bin目录下的 startup.bat / shutdown.bat 文件。</p><p>但是细心的小伙伴就会发现(╮(￣▽￣)╭)，<code>startup.bat</code> 和 <code>shutdown.bat</code> 文件中都有这么一句话。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rem ---------------------------------------------------------------------------</span><br><span class="line">rem Start / Stop script <span class="keyword">for</span> the CATALINA Server</span><br><span class="line">rem ---------------------------------------------------------------------------</span><br><span class="line">call <span class="string">"%EXECUTABLE%"</span> start / stop %CMD_LINE_ARGS%</span><br></pre></td></tr></table></figure><p>所以不论是 startup 还是 shutdown 都是执行了 <code>catalina.bat</code>，只是执行的指令不同。</p><h3 id="catalina-bat"><a href="#catalina-bat" class="headerlink" title="catalina.bat"></a>catalina.bat</h3><p>首选我们分析下 <code>catalina.bat</code> 脚本的内容：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rem Guess CATALINA_HOME <span class="keyword">if</span> not defined</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CURRENT_DIR=%cd%"</span></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%CATALINA_HOME%"</span> == <span class="string">""</span> goto gotHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CATALINA_HOME=%CURRENT_DIR%"</span></span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\catalina.bat"</span> goto okHome</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CATALINA_HOME=%cd%"</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"%CURRENT_DIR%"</span></span><br></pre></td></tr></table></figure><p>检验 CATALINA_HOME 环境变量，如果不正确则重新设置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> CLASSPATH=</span><br><span class="line"></span><br><span class="line">rem Get standard environment variables</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\bin\setenv.bat"</span> goto checkSetenvHome</span><br><span class="line">call <span class="string">"%CATALINA_BASE%\bin\setenv.bat"</span></span><br><span class="line">goto setenvDone</span><br><span class="line">:checkSetenvHome</span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\setenv.bat"</span> call <span class="string">"%CATALINA_HOME%\bin\setenv.bat"</span></span><br><span class="line">:setenvDone</span><br><span class="line"></span><br><span class="line">rem Get standard Java environment variables</span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span> goto okSetclasspath</span><br><span class="line"><span class="built_in">echo</span> Cannot find <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span></span><br><span class="line"><span class="built_in">echo</span> This file is needed to run this program</span><br><span class="line">goto end</span><br><span class="line">:okSetclasspath</span><br><span class="line">call <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span> %1</span><br><span class="line"><span class="keyword">if</span> errorlevel 1 goto end</span><br></pre></td></tr></table></figure><p>设置环境变量：</p><ul><li>在 CATALINA_BASE 和 CATALINA_BASE 寻找<code>setenv.bat</code>文件并执行，找不到则不执行。</li><li>寻找<code>setclasspath.bat</code>(设置 Java 相关的环境变量)文件并执行，找不到则结束。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rem Add tomcat-juli.jar to classpath</span><br><span class="line">rem tomcat-juli.jar can be over-ridden per instance</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\bin\tomcat-juli.jar"</span> goto juliClasspathHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CLASSPATH=%CLASSPATH%;%CATALINA_BASE%\bin\tomcat-juli.jar"</span></span><br><span class="line">goto juliClasspathDone</span><br><span class="line">:juliClasspathHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CLASSPATH=%CLASSPATH%;%CATALINA_HOME%\bin\tomcat-juli.jar"</span></span><br><span class="line">:juliClasspathDone</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JSSE_OPTS%"</span> == <span class="string">""</span> goto gotJsseOpts</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JSSE_OPTS=-Djdk.tls.ephemeralDHKeySize=2048"</span></span><br><span class="line">:gotJsseOpts</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JAVA_OPTS=%JAVA_OPTS% %JSSE_OPTS%"</span></span><br><span class="line"></span><br><span class="line">rem Register custom URL handlers</span><br><span class="line">rem Do this here so custom URL handles (specifically <span class="string">'war:...'</span>) can be used <span class="keyword">in</span> the security policy</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JAVA_OPTS=%JAVA_OPTS% -Djava.protocol.handler.pkgs=org.apache.catalina.webresources"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%LOGGING_CONFIG%"</span> == <span class="string">""</span> goto noJuliConfig</span><br><span class="line"><span class="built_in">set</span> LOGGING_CONFIG=-Dnop</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\conf\logging.properties"</span> goto noJuliConfig</span><br><span class="line"><span class="built_in">set</span> LOGGING_CONFIG=-Djava.util.logging.config.file=<span class="string">"%CATALINA_BASE%\conf\logging.properties"</span></span><br><span class="line">:noJuliConfig</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%LOGGING_MANAGER%"</span> == <span class="string">""</span> goto noJuliManager</span><br><span class="line"><span class="built_in">set</span> LOGGING_MANAGER=-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</span><br><span class="line">:noJuliManager</span><br></pre></td></tr></table></figure><p>tomcat-juli.jar：</p><ul><li>将 <strong>tomcat-juli.jar</strong> 添加到 classPath 环境变量中。</li><li>将日志的配置文件路径添加到 LOGGING_CONFIG 环境变量中。</li></ul><blockquote><p>Apache Tomcat由一个自己的实现了 java.util.logging 多个关键元素的实现。这个实现被称为 JULI 。实现的核心组件是定制化的 LogManager ，可以获取运行在Tomcat中的不同web应用(以及不同的class loader)。他支持为应用配置单独的日志配置。当有web应用从内在中是被卸载时，会接到Tomcat的通知，以便他所引用的类可以被清除，避免内存泄露。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">rem Execute The Requested Command</span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_BASE:   <span class="string">"%CATALINA_BASE%"</span></span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_HOME:   <span class="string">"%CATALINA_HOME%"</span></span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_TMPDIR: <span class="string">"%CATALINA_TMPDIR%"</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>debug<span class="string">""</span> goto use_jdk</span><br><span class="line"><span class="built_in">echo</span> Using JRE_HOME:        <span class="string">"%JRE_HOME%"</span></span><br><span class="line">goto java_dir_displayed</span><br><span class="line">:use_jdk</span><br><span class="line"><span class="built_in">echo</span> Using JAVA_HOME:       <span class="string">"%JAVA_HOME%"</span></span><br><span class="line">:java_dir_displayed</span><br><span class="line"><span class="built_in">echo</span> Using CLASSPATH:       <span class="string">"%CLASSPATH%"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> _EXECJAVA=%_RUNJAVA%</span><br><span class="line"><span class="built_in">set</span> MAINCLASS=org.apache.catalina.startup.Bootstrap</span><br><span class="line"><span class="built_in">set</span> ACTION=start</span><br><span class="line"><span class="built_in">set</span> SECURITY_POLICY_FILE=</span><br><span class="line"><span class="built_in">set</span> DEBUG_OPTS=</span><br><span class="line"><span class="built_in">set</span> JPDA=</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>jpda<span class="string">""</span> goto noJpda</span><br><span class="line"><span class="built_in">set</span> JPDA=jpda</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_TRANSPORT%"</span> == <span class="string">""</span> goto gotJpdaTransport</span><br><span class="line"><span class="built_in">set</span> JPDA_TRANSPORT=dt_socket</span><br><span class="line">:gotJpdaTransport</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_ADDRESS%"</span> == <span class="string">""</span> goto gotJpdaAddress</span><br><span class="line"><span class="built_in">set</span> JPDA_ADDRESS=localhost:8000</span><br><span class="line">:gotJpdaAddress</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_SUSPEND%"</span> == <span class="string">""</span> goto gotJpdaSuspend</span><br><span class="line"><span class="built_in">set</span> JPDA_SUSPEND=n</span><br><span class="line">:gotJpdaSuspend</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_OPTS%"</span> == <span class="string">""</span> goto gotJpdaOpts</span><br><span class="line"><span class="built_in">set</span> JPDA_OPTS=-agentlib:jdwp=transport=%JPDA_TRANSPORT%,address=%JPDA_ADDRESS%,server=y,<span class="built_in">suspend</span>=%JPDA_SUSPEND%</span><br><span class="line">:gotJpdaOpts</span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line">:noJpda</span><br></pre></td></tr></table></figure><ul><li>设置启动类 - org.apache.catalina.startup.Bootstrap</li><li>设置远程调试相关参数 - JPDA</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>debug<span class="string">""</span> goto doDebug</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>run<span class="string">""</span> goto doRun</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>start<span class="string">""</span> goto doStart</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>stop<span class="string">""</span> goto doStop</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>configtest<span class="string">""</span> goto doConfigTest</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>version<span class="string">""</span> goto doVersion</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Usage:  catalina ( commands ... )</span><br><span class="line"><span class="built_in">echo</span> commands:</span><br><span class="line"><span class="built_in">echo</span>   debug             Start Catalina <span class="keyword">in</span> a debugger</span><br><span class="line"><span class="built_in">echo</span>   debug -security   Debug Catalina with a security manager</span><br><span class="line"><span class="built_in">echo</span>   jpda start        Start Catalina under JPDA debugger</span><br><span class="line"><span class="built_in">echo</span>   run               Start Catalina <span class="keyword">in</span> the current window</span><br><span class="line"><span class="built_in">echo</span>   run -security     Start <span class="keyword">in</span> the current window with security manager</span><br><span class="line"><span class="built_in">echo</span>   start             Start Catalina <span class="keyword">in</span> a separate window</span><br><span class="line"><span class="built_in">echo</span>   start -security   Start <span class="keyword">in</span> a separate window with security manager</span><br><span class="line"><span class="built_in">echo</span>   stop              Stop Catalina</span><br><span class="line"><span class="built_in">echo</span>   configtest        Run a basic syntax check on server.xml</span><br><span class="line"><span class="built_in">echo</span>   version           What version of tomcat are you running?</span><br><span class="line">goto end</span><br></pre></td></tr></table></figure><p>这里值得注意的且常用的(start / stop)，正如开头提到的。</p><h3 id="org-apache-catalina"><a href="#org-apache-catalina" class="headerlink" title="org.apache.catalina"></a>org.apache.catalina</h3><p>解压 bin 目录中的 catalina.jar 后我们能找到 org.apache.catalina.startup.Bootstrap 也就是 catalina.bat 里设置的启动类(MAINCLASS)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">        String command = <span class="string">"start"</span>;</span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            command = args[args.length - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">            daemon.setAwait(<span class="keyword">true</span>);</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            daemon.start();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</span><br><span class="line">                daemon.stopServer(args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当指令等于<code>start</code>时运行 Catalina.class 中的 <code>start()</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Catalina</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.await) &#123;</span><br><span class="line">            <span class="keyword">this</span>.await();</span><br><span class="line">            <span class="keyword">this</span>.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在<code>start()</code>方法中调用了<code>await()</code>和<code>stop()</code>两个方法：</p><ul><li><p><code>await()</code> 方法监听停止服务请求的方法</p></li><li><p><code>stop()</code> 方法是停止服务的方法</p></li></ul><blockquote><p><code>await()</code> 方法是阻塞方法，只有客户端请求关闭Tomcat服务时，他才会执行<code>stop()</code>方法，否则一直等待关闭请求。</p></blockquote><p>StandardServer.class 中的 <code>await()</code> 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardServer</span> <span class="keyword">extends</span> <span class="title">LifecycleMBeanBase</span> <span class="keyword">implements</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServerSocket awaitSocket = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String shutdown = <span class="string">"SHUTDOWN"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.awaitSocket = <span class="keyword">new</span> ServerSocket(<span class="keyword">this</span>.getPortWithOffset(), <span class="number">1</span>,InetAddress.getByName(<span class="keyword">this</span>.address));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var67) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"standardServer.awaitSocket.fail"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>.address,String.valueOf(<span class="keyword">this</span>.getPortWithOffset()), String.valueOf(<span class="keyword">this</span>.getPort()),String.valueOf(<span class="keyword">this</span>.getPortOffset())&#125;), var67);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ServerSocket serverSocket;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/* 略 */</span></span><br><span class="line">             <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                 label611: &#123;</span><br><span class="line">                     label610: &#123;</span><br><span class="line">                         <span class="keyword">try</span> &#123;</span><br><span class="line">                             label634: &#123;</span><br><span class="line">                                 <span class="keyword">try</span> &#123;</span><br><span class="line">                                     <span class="comment">// 执行accept等待请求</span></span><br><span class="line">                                     socket = serverSocket.accept();</span><br><span class="line">                                     socket.setSoTimeout(<span class="number">10000</span>);</span><br><span class="line">                                     stream = socket.getInputStream();</span><br><span class="line">                                 &#125; <span class="keyword">catch</span> (SocketTimeoutException var69) &#123;</span><br><span class="line">                                     log.warn(sm.getString(<span class="string">"standardServer.accept.timeout"</span>, <span class="keyword">new</span> Object[]&#123;System.currentTimeMillis() - acceptStartTime&#125;), var69);</span><br><span class="line">                                     <span class="keyword">continue</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                                 <span class="comment">/* 略 */</span></span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">/* 略 */</span></span><br><span class="line">                 <span class="keyword">boolean</span> match = command.toString().equals(<span class="keyword">this</span>.shutdown);</span><br><span class="line">                 <span class="comment">// 如果请求内容与 shutdown 字段相同则跳出循环，Socket 服务停止</span></span><br><span class="line">                 <span class="keyword">if</span> (match) &#123;</span><br><span class="line">                     log.info(sm.getString(<span class="string">"standardServer.shutdownViaPort"</span>));</span><br><span class="line">                     var32 = <span class="keyword">false</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 log.warn(sm.getString(<span class="string">"standardServer.invalidShutdownCommand"</span>, <span class="keyword">new</span> Object[]&#123;command.toString()&#125;));</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到这里开启了一个 ServerSocket ，调用 accept() 方法监听请求。</p><p><code>serverSocket.close()</code>之后 <code>start()</code>方法中的<code>this.stop()</code>执行，Server 被关闭。</p><p>当指令等于<code>stop</code>时运行 Catalina.class 中的 <code>stopServer()</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">(String[] arguments)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (arguments != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.arguments(arguments);</span><br><span class="line">    &#125;</span><br><span class="line">    Server s = <span class="keyword">this</span>.getServer();</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            s.stop();</span><br><span class="line">            s.destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException var63) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"catalina.stopError"</span>), var63);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>显而易见，Server 不为 null 时，停止并且销毁。</p><h3 id="Server-中的-shutdown-属性"><a href="#Server-中的-shutdown-属性" class="headerlink" title="Server 中的 shutdown 属性"></a>Server 中的 shutdown 属性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8085"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;</span><br></pre></td></tr></table></figure><p>这里<code>shutdown</code>的默认属性就是<code>SHUTDOWN</code>，与 StandardServer 类中 shutdown 属性的值一样。</p><blockquote><p>当然 StandardServer 类中 shutdown 属性提供了 setShutdown(String shutdown) 方法。</p></blockquote><p>做个测试，我们执行 startup.bat 先启动 Tomcat ，跳出窗口并打印日志：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Tomcat</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat/9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│<span class="comment"># 略</span></span><br><span class="line">│Server startup <span class="keyword">in</span> [673] milliseconds</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>我们再启动另一个窗口，进入<code>telnet</code>：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Command Prompt</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Microsoft Windows [版本 10.0.17763.1039]</span><br><span class="line">│(c) 2018 Microsoft Corporation。保留所有权利。</span><br><span class="line">│C:\Users\Administrator&gt;telnet localhost 8005</span><br><span class="line">│正在连接localhost...</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>之后我们再像8005端口发送点东西</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Telnet localhost</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│unshell</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>发送<code>unshell</code>字符串，Tomcat窗口打印出新的内容</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Tomcat</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat&#x2F;9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│# 略</span><br><span class="line">│Server startup in [673] milliseconds</span><br><span class="line">│Invalid shutdown command [unshell] received</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>如果内容没有更新可以尝试按<code>enter</code>键</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 完整内容如下(可以看到警告的方法，就如我们之前所说的那样)</span><br><span class="line"><span class="number">23</span>-Apr-<span class="number">2020</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">20</span><span class="variable">.166</span> 警告 [main] org<span class="variable">.apache</span><span class="variable">.catalina</span><span class="variable">.core</span><span class="variable">.StandardServer</span><span class="variable">.await</span> Invalid shutdown command [unshell] received</span><br></pre></td></tr></table></figure><p>所以当我们输入指令为<code>SHUTDOWN</code>时，Tomcat 就关闭了。</p><p>当然这个指令默认监听<code>localhost</code>的关闭请求，如果要支持远程关闭的话，可以添加参数 address，例子如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8085"</span> shutdown=<span class="string">"SHUTDOWN"</span> address=<span class="string">"36.152.44.95"</span>&gt;</span><br></pre></td></tr></table></figure><p>具体版本是否支持该参数，运行 Tomcat ，文档在 <code>http://localhost:8080/docs/config/server.html</code>中有说明。</p><p>这里以版本9为例</p><p>All implementations of <strong>Server</strong> support the following attributes：</p><table><thead><tr><th>Attribute</th><th>Description</th></tr></thead><tbody><tr><td>port</td><td>The TCP/IP port number on which this server waits for a shutdown command. Set to <code>-1</code> to disable the shutdown port.</td></tr><tr><td>shutdown</td><td>The command string that must be received via a TCP/IP connection to the specified port number, in order to shut down Tomcat.</td></tr><tr><td>address</td><td>The TCP/IP address on which this server waits for a shutdown command. If no address is specified, <code>localhost</code> is used.</td></tr></tbody></table><blockquote><p>以上就是所有内容，本文只是在理解 Tomcat 时，碰巧看到的一些边缘内容，作为记录保存下来。</p></blockquote><h3 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h3><ul><li><p><a href="https://www.jianshu.com/p/b2f63ffa964c" target="_blank" rel="noopener">Tomcat catalina.bat 原理解析</a></p></li><li><p><a href="https://cloud.tencent.com/developer/article/1129737" target="_blank" rel="noopener">Tomcat 怎么停止服务的?</a></p></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h3&gt;&lt;p&gt;运行环境：Windows 10 | Apache Tomcat 9.0.34 | 博客记录时间：2020-4-23 17:16:12&lt;/p&gt;
      
    
    </summary>
    
    
    
      <category term="tomcat" scheme="https://unshell.github.io/tags/tomcat/"/>
    
  </entry>
  
  <entry>
    <title>快速使用 Tomcat</title>
    <link href="https://unshell.github.io/2020/04/23/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8Tomcat/"/>
    <id>https://unshell.github.io/2020/04/23/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8Tomcat/</id>
    <published>2020-04-23T00:44:09.000Z</published>
    <updated>2020-06-12T08:48:04.994Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>运行环境：Windows 10 | Apache Tomcat 9.0.34 | Java 1.8.0 | 博客记录时间：2020-4-23 08:59:27</p><h3 id="下载-Tomcat"><a href="#下载-Tomcat" class="headerlink" title="下载 Tomcat"></a>下载 Tomcat</h3><p>首先进入到 <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat官网</a> ，这里我们以 <a href="https://tomcat.apache.org/download-90.cgi" target="_blank" rel="noopener">版本9</a> 进行举例 (目前最新版本为10)。</p><h3 id="9-0-34"><a href="#9-0-34" class="headerlink" title="9.0.34"></a>9.0.34</h3><h4 id="Binary-Distributions"><a href="#Binary-Distributions" class="headerlink" title="Binary Distributions"></a>Binary Distributions</h4><ul><li>Core:<ul><li><a href="https://mirror.bit.edu.cn/apache/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.zip" target="_blank" rel="noopener">zip</a> (<a href="https://downloads.apache.org/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.zip.asc" target="_blank" rel="noopener">pgp</a>, <a href="https://downloads.apache.org/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.zip.sha512" target="_blank" rel="noopener">sha512</a>)</li></ul></li></ul><p>这里我们直接点击 zip 下载，下载完之后文件目录如下：</p><ul><li>apache-tomcat-9.0.34<ul><li>bin - 运行文件，Windows环境下的.bat和Linux环境下的.sh</li><li>conf - 常用到的一些配置文件</li><li>lib - 一些 Java 的 Jar 包</li><li>logs - 日志</li><li>temp - 临时文件</li><li>webapps - 默认虚拟主机的默认项目根目录</li><li>work - 项目部署后的缓存文件目录</li></ul></li></ul><p>除了以前的文件夹外还有一些文件，如 README.md 文件</p><blockquote><p>官网：Please see the README file for packaging information. It explains what every distribution contains. </p></blockquote><h3 id="运行-Tomcat"><a href="#运行-Tomcat" class="headerlink" title="运行 Tomcat"></a>运行 Tomcat</h3><p>我们可以看到 webapps 目录下有5个初始项目：</p><ul><li>webapps<ul><li>docs</li><li>examples</li><li>host-manager</li><li>manager</li><li>ROOT</li></ul></li></ul><blockquote><p>Tomcat 中 bin 和 lib 文件中的 Jar 包说明了需要在 Java 环境下运行</p></blockquote><p>然后我们运行 bin 目录下的 startup.bat 文件，如果出现终端窗口一直在打印日志说明运行成功：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Command Prompt</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat/9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│OS Name:Windows 10</span><br><span class="line">│OS.版本:10.0</span><br><span class="line">│架构:amd64</span><br><span class="line">│Java 环境变量: C:\Program Files\Java\jdk1.8.0_251\jre</span><br><span class="line">│JVM 版本:1.8.0_251-b08</span><br><span class="line">│JVM.供应商:Oracle Corporation</span><br><span class="line">│--- 略 ---</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>打印的内容大致如上，这时候使用浏览器访问 <code>localhost:8080</code>，就能看到 Tomcat 的如下页面：</p><p><img src="/blog/css/images/article/tomcat/01.png" alt="webapps 目录下的 ROOT 项目"></p><blockquote><p>值得注意的是 work 目录中生成了对应项目的文件夹，但内容为空。以及 logs 文件中生成的日志文件，如 catalina.*.log 中的内容就是终端窗口打印的内容。</p></blockquote><h3 id="日志输出乱码问题"><a href="#日志输出乱码问题" class="headerlink" title="日志输出乱码问题"></a>日志输出乱码问题</h3><p>当窗口运行时输出的日志出现乱码，如<code>淇℃伅</code>之类的内容说明当前系统的默认字符与 conf 文件夹中 logging.properties 文件中 encoding 属性设置不相同(默认配置为UTF-8)。</p><h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Command Prompt</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Microsoft Windows [版本 10.0.17763.1039]</span><br><span class="line">│(c) 2018 Microsoft Corporation。保留所有权利。</span><br><span class="line">│C:\Users\Administrator&gt;chcp</span><br><span class="line">│活动代码页: 936</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure><p>获取当前系统活动代码页，找到对应编码，如下表：</p><table><thead><tr><th>活动代码页</th><th>编码</th></tr></thead><tbody><tr><td>936</td><td>简体中文(GBK)</td></tr><tr><td>65001</td><td>UTF-8Unicode</td></tr></tbody></table><p>然后修改 logging.properties 中 encoding = GBK，如下：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment"># Handler specific properties.</span></span><br><span class="line"><span class="comment"># Describes specific configuration info for Handlers.</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.level</span> = <span class="string">FINE</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.directory</span> = <span class="string">$&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.prefix</span> = <span class="string">catalina.</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.maxDays</span> = <span class="string">90</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.encoding</span> = <span class="string">GBK</span></span><br></pre></td></tr></table></figure><h3 id="发布项目"><a href="#发布项目" class="headerlink" title="发布项目"></a>发布项目</h3><h4 id="1-添加-war-包到-webapps-中"><a href="#1-添加-war-包到-webapps-中" class="headerlink" title="1.添加 war 包到 webapps 中"></a>1.添加 war 包到 webapps 中</h4><ul><li>webapps<ul><li>FlogShiro.war</li></ul></li></ul><h4 id="2-执行-startup-bat-文件-如之前在执行状态先执行-shutdown-bat-文件"><a href="#2-执行-startup-bat-文件-如之前在执行状态先执行-shutdown-bat-文件" class="headerlink" title="2.执行 startup.bat 文件 (如之前在执行状态先执行 shutdown.bat 文件)"></a>2.执行 startup.bat 文件 (如之前在执行状态先执行 shutdown.bat 文件)</h4><p>打印出日志，并且在webapps中解压war，多出项目文件夹：</p><ul><li>webapps<ul><li>FlogShiro (解压的项目文件)</li><li>FlogShiro.war</li></ul></li></ul><h4 id="3-访问网站"><a href="#3-访问网站" class="headerlink" title="3.访问网站"></a>3.访问网站</h4><p><code>localhost:8080/FlogShiro/index.html</code></p><p>默认监听端口为<code>8080</code>，项目名为FlogShiro，展示页面为index.html</p><blockquote><p>具体内容根据实际情况决定</p></blockquote><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>目前我们还没提到 conf 文件夹，以发布项目中的例子查看 conf &gt; server.xml 文件</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 删除注解后内容如下 --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这里我们值得注意的就是 <code>Server</code>、<code>Service</code> 和 <code>Connector</code> 以及 <code>Host</code></p><ul><li>Server<ul><li>port （服务器监听端口）</li><li>shutdown (关闭指令)</li></ul></li><li>Service<ul><li>name (服务名)</li></ul></li><li>Connector<ul><li>port (服务监听端口)</li><li>protocol (协议类型)</li><li>connectionTimeout (连接超时)</li><li>redirectPort (端口重定向)</li></ul></li><li>Host<ul><li>name (虚拟主机名称)</li><li>appBase (项目根目录)</li><li>unpackWARs (解压War包)</li><li>autoDeploy (自动部署)</li></ul></li></ul><p>显而易见，以发布项目的例子可以看出名为 localhost 的虚拟主机的根目录为 webapps ，并且配置了解压 war 包，Service监听的端口为 <code>8080</code> 。</p><p>所以当我们访问 <code>localhost:8080</code> 访问到了 webapps 目录下的ROOT，而访问 <code>localhost:8080/FlogShiro</code> 则访问到了指定FlogShiro项目。</p><h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>为什么我们访问 <code>localhost</code> 和 <code>127.0.0.1</code> 访问到的东西是一样，因为本机已经做好了IP和域名的本地映射</p><p>找到 C:\Windows\System32\drivers\etc 中的<code>hosts</code>文件(C为系统盘)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Copyright (c) 1993-2009 Microsoft Corp.</span><br><span class="line">#</span><br><span class="line"># This is a sample HOSTS file used by Microsoft TCP&#x2F;IP for Windows.</span><br><span class="line">#</span><br><span class="line"># This file contains the mappings of IP addresses to host names. Each</span><br><span class="line"># entry should be kept on an individual line. The IP address should</span><br><span class="line"># be placed in the first column followed by the corresponding host name.</span><br><span class="line"># The IP address and the host name should be separated by at least one</span><br><span class="line"># space.</span><br><span class="line">#</span><br><span class="line"># Additionally, comments (such as these) may be inserted on individual</span><br><span class="line"># lines or following the machine name denoted by a &#39;#&#39; symbol.</span><br><span class="line">#</span><br><span class="line"># For example:</span><br><span class="line">#</span><br><span class="line">#      102.54.94.97     rhino.acme.com          # source server</span><br><span class="line">#       38.25.63.10     x.acme.com              # x client host</span><br><span class="line"></span><br><span class="line"># localhost name resolution is handled within DNS itself.</span><br><span class="line"># 本地主机名称解析是在DNS本身内处理的。</span><br><span class="line">#127.0.0.1       localhost</span><br><span class="line">#::1             localhost</span><br></pre></td></tr></table></figure><p>你可以按照上面的 <code>example</code> 添加虚拟主机名称，这样Tomcat配置文件夹下server.xml中Host属性name可以使用添加的主机名称。</p><blockquote><p>当然如果你不想在 webapps 中添加项目，你也可以新添加的主机中配置其他文件夹问根目录。</p><p>注意：在访问中(具体得看实际情况)，webapps 中可能存在一些会发生冲突的项目名，如 manager</p></blockquote><h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><ul><li><a href="https://tomcat.apache.org/tomcat-9.0-doc/index.html" target="_blank" rel="noopener">Apache Tomcat 9 (9.0.36) - Documentation Index</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;p&gt;运行环境：Windows 10 | Apache Tomcat 9.0.34 | Java 1.8.0 | 博客记录时间：2020-4-23
      
    
    </summary>
    
    
    
      <category term="tomcat" scheme="https://unshell.github.io/tags/tomcat/"/>
    
      <category term="fast" scheme="https://unshell.github.io/tags/fast/"/>
    
  </entry>
  
  <entry>
    <title>正则表达式</title>
    <link href="https://unshell.github.io/2020/04/22/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    <id>https://unshell.github.io/2020/04/22/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/</id>
    <published>2020-04-22T00:57:16.000Z</published>
    <updated>2020-04-22T01:25:02.517Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>虽然正则内容不算很多但是用好正则还是得花一些时间的，这篇文章只是做简单的记录</p></blockquote><h3 id="运算符类型"><a href="#运算符类型" class="headerlink" title="运算符类型"></a>运算符类型</h3><ul><li>转义符 <code>/</code> </li><li>圆括号和方括号 <code>()</code> 、<code>[]</code> </li><li>限定符 <code>*</code> 、<code>+</code> 、<code>?</code> 、<code>{n}</code>、<code>{n,}</code>、<code>{n,m}</code> </li><li>定位点和序列 <code>^</code> 、<code>$</code> 、<code>\</code> </li><li>替换，或操作 <code>|</code> </li></ul><h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><p>以JavaScript为例使用正则的方法：</p><ul><li>/[a-z]*/</li><li>^[a-z]*$</li></ul><p>圆括号相当于子表达式，类似组的概念可以被重复使用</p><ul><li>/\b([a-z]+) \1\b/</li><li>/\b([a-z]+) ([a-z]+)\b/</li></ul><p>两者效果一样</p><p><code>^</code>虽然为定位符，但是在<code>[]</code>中起到非的作用</p><h3 id="推荐网站"><a href="#推荐网站" class="headerlink" title="推荐网站"></a>推荐网站</h3><ul><li><a href="https://regexper.com/" target="_blank" rel="noopener">以SVG的样式展示正则的规则</a></li><li><a href="https://regex101.com/" target="_blank" rel="noopener">比较实用的正则检测网站</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;blockquote&gt;
&lt;p&gt;虽然正则内容不算很多但是用好正则还是得花一些时间的，这篇文章只是做简单的记录&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;运算符类型&quot;&gt;&lt;a href=&quot;#运算符类型&quot; class=&quot;headerlink&quot; title=&quot;运算符类型&quot;&gt;&lt;/
      
    
    </summary>
    
    
    
      <category term="regex" scheme="https://unshell.github.io/tags/regex/"/>
    
  </entry>
  
  <entry>
    <title>CentOs 安装 MySql</title>
    <link href="https://unshell.github.io/2020/04/21/CentOs%E5%AE%89%E8%A3%85MySql/"/>
    <id>https://unshell.github.io/2020/04/21/CentOs%E5%AE%89%E8%A3%85MySql/</id>
    <published>2020-04-21T07:10:18.000Z</published>
    <updated>2020-06-12T08:26:02.795Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><p>系统：CentOS Linux release 8.1.1911 (Core) | MySQL版本：8.0.17 | 博客记录时间：2020-4-21 15:21:36</p><h2 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h2><p>查看MySQL <a href="https://www.mysql.com/" target="_blank" rel="noopener">官网</a> 提供的 <a href="https://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="noopener">MySQL Yum Repository</a> ，这里我们选择 <strong>Red Hat Enterprise Linux 8 / Oracle Linux 8 (Architecture Independent), RPM Package</strong></p><blockquote><p>根据自己的 Linux 版本挑选 RPM Package 版本，这里演示的环境是 Linux 8</p></blockquote><h3 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 直接切换成root账号,避免权限不足造成其他问题</span></span><br><span class="line">[unshell@localhost /]$ su root</span><br><span class="line">Password: </span><br><span class="line">[root@localhost /]# </span><br><span class="line"><span class="meta">#</span><span class="bash"> 当然你如果不想切换账号,那在需要权限的命令前加上sudo</span></span><br><span class="line">[unshell@localhost /]$ sudo [需要权限的命令]</span><br><span class="line">Password:</span><br></pre></td></tr></table></figure><h3 id="安装YUM仓库"><a href="#安装YUM仓库" class="headerlink" title="安装YUM仓库"></a>安装YUM仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载到当前目录下</span></span><br><span class="line">wget https://repo.mysql.com//mysql80-community-release-el8-1.noarch.rpm</span><br><span class="line"><span class="comment"># 使用 yum 本地安装</span></span><br><span class="line">yum localinstall mysql80-community-release-el8-1.noarch.rpm</span><br><span class="line"><span class="comment"># 查看包源是否安装成功</span></span><br><span class="line">yum repolist enabled | grep <span class="string">"mysql.*-community.*"</span></span><br><span class="line"><span class="comment"># 输出内容如下</span></span><br><span class="line">mysql-connectors-community           MySQL Connectors Community              42</span><br><span class="line">mysql-tools-community                MySQL Tools Community                   19</span><br><span class="line">mysql80-community                    MySQL 8.0 Community Server              31</span><br></pre></td></tr></table></figure><h3 id="配置MySQL服务"><a href="#配置MySQL服务" class="headerlink" title="配置MySQL服务"></a>配置MySQL服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装MySQL服务</span></span><br><span class="line">yum install mysql-server</span><br><span class="line"><span class="comment"># 启动MySQL服务</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line"><span class="comment"># 查看MySQL服务状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"><span class="comment"># 输出如下则表示开启</span></span><br><span class="line">● mysqld.service - MySQL 8.0 database server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Tue 2020-04-21 16:22:47 CST; 10s ago</span><br><span class="line">  Process: 11914 ExecStartPost=/usr/libexec/mysql-check-upgrade (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 11787 ExecStartPre=/usr/libexec/mysql-prepare-db-dir mysqld.service (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 11763 ExecStartPre=/usr/libexec/mysql-check-socket (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 11871 (mysqld)</span><br><span class="line">   Status: <span class="string">"Server is operational"</span></span><br><span class="line">    Tasks: 39 (<span class="built_in">limit</span>: 4888)</span><br><span class="line">   Memory: 328.3M</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─11871 /usr/libexec/mysqld --basedir=/usr</span><br></pre></td></tr></table></figure><h3 id="配置MySQL数据库"><a href="#配置MySQL数据库" class="headerlink" title="配置MySQL数据库"></a>配置MySQL数据库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 查看MySQL服务日志与password相关的内容</span><br><span class="line">grep &#39;password&#39; &#x2F;var&#x2F;log&#x2F;mysql&#x2F;mysqld.log</span><br><span class="line"># 演示时输出如下</span><br><span class="line">2020-04-21T08:22:41.675426Z 5 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.</span><br><span class="line"># 这里提示我们Server为root@localhost账号创建了个空的密码,我们这里直接登入MySQL</span><br><span class="line">mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line"># 直接回车，输出如下及登入成功</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.17 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and&#x2F;or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"># 修改root@localhost的密码(这里演示修改密码为：qwe123)</span><br><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;qwe123&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.08 sec)</span><br><span class="line"># 为外网访问添加账户(%代表所有地址都可能访问,使用时根据实际情况)</span><br><span class="line">CREATE USER &#39;unshell&#39;@&#39;%&#39; IDENTIFIED BY &#39;qwe123&#39;;</span><br><span class="line"># 授予权限(这里演示提供所有权限,使用时根据实际情况)</span><br><span class="line">GRANT ALL ON *.* TO &#39;unshell&#39;@&#39;%&#39; WITH GRANT OPTION;</span><br></pre></td></tr></table></figure><h3 id="开启防火墙对应端口"><a href="#开启防火墙对应端口" class="headerlink" title="开启防火墙对应端口"></a>开启防火墙对应端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开放默认3306端口</span></span><br><span class="line">firewall-cmd --add-port=3306/tcp --permanent</span><br><span class="line"><span class="comment"># 输出success说明成功</span></span><br><span class="line">success</span><br><span class="line"><span class="comment"># 更新防火墙规则</span></span><br><span class="line">firewall-cmd --reload</span><br><span class="line"><span class="comment"># 查看防火墙状况</span></span><br><span class="line">firewall-cmd --list-all</span><br><span class="line"><span class="comment"># 输出内容如下说明成功添加3306端口</span></span><br><span class="line">public (active)</span><br><span class="line">  target: default</span><br><span class="line">  icmp-block-inversion: no</span><br><span class="line">  interfaces: ens160</span><br><span class="line">  services: cockpit dhcpv6-client ssh</span><br><span class="line">  ports: 3306/tcp </span><br><span class="line"><span class="comment"># 如果未成功，可以尝试重启防火墙</span></span><br><span class="line">firewall-cmd --complete-reload</span><br></pre></td></tr></table></figure><h2 id="卸载MySQL"><a href="#卸载MySQL" class="headerlink" title="卸载MySQL"></a>卸载MySQL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭MySQL服务</span></span><br><span class="line">systemctl stop mysqld</span><br><span class="line"><span class="comment"># 查找已安装的MySQl相关的包</span></span><br><span class="line">rpm -qa|grep -i mysql</span><br><span class="line"><span class="comment"># 移除输出的包</span></span><br><span class="line">yum remove [package]</span><br><span class="line"><span class="comment"># 查询相关的文件夹</span></span><br><span class="line">find / -name mysql</span><br><span class="line"><span class="comment"># 删除输出的文件夹</span></span><br><span class="line">rm -rf [directory]</span><br><span class="line"><span class="comment"># 有需要的话也可以3306端口</span></span><br><span class="line">firewall-cmd --permanent --remove-port=3306/tcp</span><br></pre></td></tr></table></figure><h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><ul><li><a href="https://dev.mysql.com/doc/refman/8.0/en/linux-installation-yum-repo.html" target="_blank" rel="noopener">Installing MySQL on Linux Using the MySQL Yum Repository</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;安装环境&quot;&gt;&lt;a href=&quot;#安装环境&quot; class=&quot;headerlink&quot; title=&quot;安装环境&quot;&gt;&lt;/a&gt;安装环境&lt;/h2&gt;&lt;p&gt;系统：CentOS Linux release 8.1.1911 (Core) | MySQL版本：8.0.17 | 博客记
      
    
    </summary>
    
    
    
      <category term="linux" scheme="https://unshell.github.io/tags/linux/"/>
    
      <category term="mysql" scheme="https://unshell.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>Windows 安装 Mysql</title>
    <link href="https://unshell.github.io/2020/03/03/Windows%E5%AE%89%E8%A3%85Mysql/"/>
    <id>https://unshell.github.io/2020/03/03/Windows%E5%AE%89%E8%A3%85Mysql/</id>
    <published>2020-03-03T00:36:43.000Z</published>
    <updated>2020-06-12T08:41:24.207Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>操作系统：Windows 10 | MySQL 版本 8.0.16 | 博客记录时间：2020/3/1 16:05</p><h3 id="安装-MySQL-Community-Server"><a href="#安装-MySQL-Community-Server" class="headerlink" title="安装 MySQL Community Server"></a>安装 MySQL Community Server</h3><p>进入 MySQL官网 <a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">下载最新版</a> 或 <a href="https://downloads.mysql.com/archives/community/" target="_blank" rel="noopener">其他版本</a> ZIP Archive：</p><p><img src="/blog/css/images/article/mysql/fast-use-mysql01.png" alt="fast-use-mysql01"></p><blockquote><p>当前最高版本是8.0.19，我们这里拿8.0.16做演示，目前来说8系列安装都差不多</p></blockquote><p>点击下载后进入到下个页面，选择 No thanks, just start my download：</p><p><img src="/blog/css/images/article/mysql/fast-use-mysql02.png" alt="fast-use-mysql02"></p><p>下载完之后进行解压，这里我们把压缩包解压在 F:\mysql</p><p>以 <strong>管理员的身份</strong> 打开 cmd 命令行工具，切换目录并输入 mysql 如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">cd</span> F:\mysql\bin</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql</span></span><br><span class="line">// 如果输出如下，就可以开始装载服务了</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ERROR 2003 (HY000): Can<span class="string">'t connect to MySQL server on '</span>localhost<span class="string">' (10061)</span></span></span><br></pre></td></tr></table></figure><blockquote><p>如果你的系统特别干净，可能会跳出提示框提示你缺少dll文件，只要把 <a href="/blog/css/images/article/mysql/msvcp140.dll">msvcp140.dll</a> 和 <a href="/blog/css/images/article/mysql/vcruntime140.dll">vcruntime140.dll</a> 放在 系统盘的Windows\System32 文件夹下再输入 mysql 就可以了。</p></blockquote><h3 id="配置-MySQL-服务"><a href="#配置-MySQL-服务" class="headerlink" title="配置 MySQL 服务"></a>配置 MySQL 服务</h3><p>在配置 MySQL 服务之前，我们先配置下 MySQL 的配置文件，创建名为 <strong>my.ini</strong> 的文件在 F:\mysql\ 目录下，配置内容如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="comment"># 设置mysql客户端默认字符集</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 设置3306端口</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="comment"># 设置mysql的安装目录</span></span><br><span class="line"><span class="attr">basedir</span>=F:\\mysql</span><br><span class="line"><span class="comment"># 设置 mysql数据库的数据的存放目录，MySQL 8+ 不需要以下配置，系统自己生成即可，否则有可能报错</span></span><br><span class="line"><span class="comment"># datadir=F:\\sqldata</span></span><br><span class="line"><span class="comment"># 允许最大连接数</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="number">100</span></span><br><span class="line"><span class="comment"># 服务端使用的字符集默认为8比特编码的latin1字符集</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8mb4</span><br><span class="line"><span class="comment"># 创建新表时将使用的默认存储引擎</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=INNODB</span><br></pre></td></tr></table></figure><p>之后我们再使用 cmd 命令行工具初始化数据库：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysqld --initialize --console</span></span><br></pre></td></tr></table></figure><ul><li>–initialize : 初始化</li><li>–console : 输出在控制台</li></ul><p>执行完成后，会输出 root 用户的初始化密码，如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ....</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> [Note] [MY-010454] [Server] A temporary password is generated <span class="keyword">for</span> root@localhost: g)tqN+Oia4_a</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ....</span></span><br></pre></td></tr></table></figure><p><strong>g)tqN+Oia4_a</strong> 就是初始化密码，之后登入会用到：</p><p>输入以下安装命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysqld install</span></span><br></pre></td></tr></table></figure><p>之后启动服务：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> net start mysql</span></span><br></pre></td></tr></table></figure><h3 id="登入MySQL"><a href="#登入MySQL" class="headerlink" title="登入MySQL"></a>登入MySQL</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql -h 主机名 -u 用户名 -p</span></span><br></pre></td></tr></table></figure><p>参数说明：</p><ul><li>-h：指定客户端要登录的 MySQL 主机名，登录本机（localhost 或 127.0.0.1）该参数可以省略；</li><li>-u：登录的用户名；</li><li>-p：告诉服务器将会使用一个密码来登录，如果所要登录的用户名密码为空, 可以忽略此选项。</li></ul><p>登入实例如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql -u root -p</span></span><br></pre></td></tr></table></figure><p>按 Enter 键后确认，如果MySQL正在运行则会得到如下响应：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter password:</span><br></pre></td></tr></table></figure><p>输入刚才的密码：<strong>g)tqN+Oia4_a</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 8.0.16 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"><span class="meta">mysql&gt;</span></span><br></pre></td></tr></table></figure><p>如果输出为以上的内容说明已经可以登录 MySQL 了。</p><h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>值得一提的是MySQL 8和低版本的MySQL修改密码的方式有差别，而且密码的编码方式也有区别</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;qwe123&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.34 sec)</span><br></pre></td></tr></table></figure><p>如果你使用数据库连接工具，如 <strong>Navicat Premium</strong> 连接的时候可能在当前版本得修改密码编码方式，否者会提示：</p><blockquote><p>[ERROR 2059] - Authentication plugin ‘caching_sha2_password’ cannot be loaded…</p></blockquote><p>修改密码编码方式如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;qwe123&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">mysql&gt; SELECT HOST,USER,PLUGIN FROM MYSQL.USER;</span><br><span class="line">+-----------+------------------+-----------------------+</span><br><span class="line">| HOST      | USER             | PLUGIN                |</span><br><span class="line">+-----------+------------------+-----------------------+</span><br><span class="line">| localhost | mysql.infoschema | caching_sha2_password |</span><br><span class="line">| localhost | mysql.session    | caching_sha2_password |</span><br><span class="line">| localhost | mysql.sys        | caching_sha2_password |</span><br><span class="line">| localhost | root             | mysql_native_password |</span><br><span class="line">+-----------+------------------+-----------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>可以看到用户为 root 的 PLUGIN 已经改成了 mysql_native_password。</p><p>到这里就一切准备就绪了！</p><h2 id="删除-MySQL-Community-Server"><a href="#删除-MySQL-Community-Server" class="headerlink" title="删除 MySQL Community Server"></a>删除 MySQL Community Server</h2><h3 id="停止服务"><a href="#停止服务" class="headerlink" title="停止服务"></a>停止服务</h3><p>使用管理员身份打开 CMD ，输入net stop mysql：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> net stop mysql</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> MySQL 服务正在停止...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> MySQL 服务已成功停止。</span></span><br><span class="line">// 如果不是管理员身份可能发生下面的情况</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 发生系统错误 5。</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 拒接访问。</span></span><br></pre></td></tr></table></figure><h3 id="删除-Windows-注册表"><a href="#删除-Windows-注册表" class="headerlink" title="删除 Windows 注册表"></a>删除 Windows 注册表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> sc delete mysql</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> [SC] DeleteService 成功</span></span><br></pre></td></tr></table></figure><h3 id="删除环境变量"><a href="#删除环境变量" class="headerlink" title="删除环境变量"></a>删除环境变量</h3><p>如果之前有配置环境变量的话，将Path里关于MySQL的环境变量删除即可</p><h3 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h3><ul><li><a href="https://www.runoob.com/mysql/mysql-install.html" target="_blank" rel="noopener">MySQL 安装 | 菜鸟教程</a></li><li><a href="https://dev.mysql.com/doc/refman/8.0/en/windows-installation.html" target="_blank" rel="noopener">Installing MySQL on Microsoft Windows</a></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;环境&quot;&gt;&lt;a href=&quot;#环境&quot; class=&quot;headerlink&quot; title=&quot;环境&quot;&gt;&lt;/a&gt;环境&lt;/h2&gt;&lt;p&gt;操作系统：Windows 10 | MySQL 版本 8.0.16 | 博客记录时间：2020/3/1 16:05&lt;/p&gt;
&lt;h3 id=&quot;
      
    
    </summary>
    
    
    
      <category term="mysql" scheme="https://unshell.github.io/tags/mysql/"/>
    
      <category term="windows" scheme="https://unshell.github.io/tags/windows/"/>
    
  </entry>
  
</feed>
