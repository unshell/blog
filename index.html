<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Unshell&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Unshell的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Unshell&#39;s Blog">
<meta property="og:url" content="https://unshell.github.io/index.html">
<meta property="og:site_name" content="Unshell&#39;s Blog">
<meta property="og:description" content="Unshell的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Unshell">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blog/atom.xml" title="Unshell&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/blog/favicon.jpg">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/blog/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blog/" id="logo">Unshell&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/blog/" id="subtitle">我相信所有坚韧不拔的努力，迟早会得来好报酬。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blog/">home</a>
        
          <a class="main-nav-link" href="/blog/archives">archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://unshell.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-发布项目到Tomcat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/05/28/%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE%E5%88%B0Tomcat/" class="article-date">
  <time datetime="2020-05-28T01:42:54.000Z" itemprop="datePublished">2020-05-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/05/28/%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE%E5%88%B0Tomcat/">发布项目到Tomcat</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="排除Spring-Boot-内置的Tomcat"><a href="#排除Spring-Boot-内置的Tomcat" class="headerlink" title="排除Spring Boot 内置的Tomcat"></a>排除Spring Boot 内置的Tomcat</h3><p>将pom.xml文件中的<code>&lt;exclusions&gt;</code>注释排除</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># 修改前</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 移除嵌入式tomcat方式 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;exclusions&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;exclusion&gt;--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;/exclusion&gt;--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;/exclusions&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"># 修改后</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 移除嵌入式tomcat方式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"># 修改完后 Import Changes,更新配置</span><br></pre></td></tr></table></figure>

<h3 id="检查项目中的相关配置"><a href="#检查项目中的相关配置" class="headerlink" title="检查项目中的相关配置"></a>检查项目中的相关配置</h3><ul>
<li>application.yml 文件中的 spring-profiles-active（测试:dev，线上master）</li>
<li>flog.properties 文件中的配置如SMS，File路径改成相应环境的（注意 linux 下没有盘符）</li>
</ul>
<h3 id="Maven-Projects"><a href="#Maven-Projects" class="headerlink" title="Maven Projects"></a>Maven Projects</h3><ul>
<li>清除 clean</li>
<li>打包 package</li>
<li>打包成功显示 BUILD SUCCESS 和 war 包的位置<code>target\ROOT.war</code></li>
</ul>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><h4 id="1-将-War-包上传到服务"><a href="#1-将-War-包上传到服务" class="headerlink" title="1.将 War 包上传到服务"></a>1.将 War 包上传到服务</h4><h4 id="2-复制到-Tomcat-项目的文件下"><a href="#2-复制到-Tomcat-项目的文件下" class="headerlink" title="2.复制到 Tomcat 项目的文件下"></a>2.复制到 Tomcat 项目的文件下</h4><blockquote>
<p>树莓派账号：pi，项目位置为：/home/pi/Documents/apache-tomcat-9.0.34/penxin_apps</p>
</blockquote>
<h4 id="3-覆盖掉-ROOT-war"><a href="#3-覆盖掉-ROOT-war" class="headerlink" title="3.覆盖掉 ROOT.war"></a>3.覆盖掉 ROOT.war</h4><h4 id="4-重启-Tomcat（bin目录）"><a href="#4-重启-Tomcat（bin目录）" class="headerlink" title="4.重启 Tomcat（bin目录）"></a>4.重启 Tomcat（bin目录）</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 关闭Tomcat</span></span><br><span class="line">./shutdown.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启Tomcat</span></span><br><span class="line">./startup.sh</span><br></pre></td></tr></table></figure>

<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><h4 id="1-打包名称"><a href="#1-打包名称" class="headerlink" title="1.打包名称"></a>1.打包名称</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 打包后的名称 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>ROOT<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 这里打包名为ROOT是因为Tomcat应用程序目录的根目录为ROOT,所以命名为ROOT后不需要在配置中指定项目位置 --&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="2-打包前必须要-Clean-确保-Target-文件夹干净"><a href="#2-打包前必须要-Clean-确保-Target-文件夹干净" class="headerlink" title="2.打包前必须要 Clean 确保 Target 文件夹干净"></a>2.打包前必须要 Clean 确保 Target 文件夹干净</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/05/28/%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE%E5%88%B0Tomcat/" data-id="ckaq4osl70008cksm6p6y77rv" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/other/" rel="tag">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-部署外置Tomcat项目" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/04/27/%E9%83%A8%E7%BD%B2%E5%A4%96%E7%BD%AETomcat%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time datetime="2020-04-27T00:14:16.000Z" itemprop="datePublished">2020-04-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/04/27/%E9%83%A8%E7%BD%B2%E5%A4%96%E7%BD%AETomcat%E9%A1%B9%E7%9B%AE/">部署外置Tomcat项目</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-引用master配置文件"><a href="#1-引用master配置文件" class="headerlink" title="1.引用master配置文件"></a>1.引用master配置文件</h3><p>将 src 下 main 里的 application.yml 文件配置修改成 master：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line"><span class="comment"># 修改成如下</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<h3 id="2-静态配置文件"><a href="#2-静态配置文件" class="headerlink" title="2.静态配置文件"></a>2.静态配置文件</h3><p>将 src 下 main 里的 flog.properties 里的配置切换成线上</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试(短信不开启|0关闭，1开启) !!!</span></span><br><span class="line"><span class="meta">flog.sms.valid</span>=<span class="string">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File 路径配置(master)</span></span><br><span class="line"><span class="meta">flog.file.root</span>=<span class="string">/root/tomcat9/webapps/ChanRongImg</span></span><br><span class="line"><span class="meta">flog.file.path</span>=<span class="string">/upload/</span></span><br><span class="line"><span class="meta">flog.file.time</span>=<span class="string">0</span></span><br><span class="line"><span class="meta">flog.file.server</span>=<span class="string">image.cryqh.com</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># dev</span></span><br><span class="line"><span class="comment"># flog.file.root=D:/ChanRongImg</span></span><br><span class="line"><span class="comment"># flog.file.path=/upload/</span></span><br><span class="line"><span class="comment"># flog.file.time=0</span></span><br><span class="line"><span class="comment"># flog.file.server=117.148.157.223:8888</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>测试环境下 flog.sms.valid=0 ，将短信关闭</li>
<li>不需要的部分注释</li>
</ul>
<blockquote>
<p>以上配置是线上的标准配置</p>
</blockquote>
<h3 id="3-修改pom-xml文件"><a href="#3-修改pom-xml文件" class="headerlink" title="3.修改pom.xml文件"></a>3.修改pom.xml文件</h3><p><strong>1.移除 SpringBoot 内置的 Tomcat</strong>，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 移除嵌入式tomcat方式(master) --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>排除的 Jar 包，包含在 exclusions 内</p>
</blockquote>
<p><strong>2.修改数据库引擎引用的Jar包</strong>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- mysql 8 (dev) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- mysql 5 (master)--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.31<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果为线上发布，将 mysql 8 的驱动注释</p>
<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><p><img src="/blog/css/images/article/tomcat/03.png" alt="打包"></p>
<ul>
<li>双击 packing</li>
<li>日志输出 BUILD SUCCESS</li>
<li>target 文件内 ChanRong.war 为最终的包</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/04/27/%E9%83%A8%E7%BD%B2%E5%A4%96%E7%BD%AETomcat%E9%A1%B9%E7%9B%AE/" data-id="ckaq4osla000bcksmeiukf5n1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/other/" rel="tag">other</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Tomcat部署项目时遇到的问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/04/23/Tomcat%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2020-04-23T09:23:19.000Z" itemprop="datePublished">2020-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/04/23/Tomcat%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/">Tomcat 部署项目时遇到的问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-org-apache-catalina-webresources-Cache-getResource-Unable-to-add-the-resource"><a href="#1-org-apache-catalina-webresources-Cache-getResource-Unable-to-add-the-resource" class="headerlink" title="1.org.apache.catalina.webresources.Cache.getResource Unable to add the resource"></a>1.org.apache.catalina.webresources.Cache.getResource Unable to add the resource</h3><p><strong>原因：</strong>资源缓存空间不足，得配置更大的资源缓存空间</p>
<p><strong>解决方法：</strong>修改 Tomcat 文件夹下 conf 文件中的 context.xml 文件，添加内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Resources</span> <span class="attr">cachingAllowed</span>=<span class="string">"true"</span> <span class="attr">cacheMaxSize</span>=<span class="string">"150000"</span> &gt;</span><span class="tag">&lt;/<span class="name">Resources</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-org-apache-catalina-core-NamingContextListener-lifecycleEvent-naming-namingContextCreationFailed"><a href="#2-org-apache-catalina-core-NamingContextListener-lifecycleEvent-naming-namingContextCreationFailed" class="headerlink" title="2.org.apache.catalina.core.NamingContextListener.lifecycleEvent naming.namingContextCreationFailed"></a>2.org.apache.catalina.core.NamingContextListener.lifecycleEvent naming.namingContextCreationFailed</h3><p><strong>原因</strong>：命名监听器创建失败</p>
<h3 id="3-org-apache-jasper-servlet-TldScanner-scanJars-至少有一个JAR被扫描用于TLD但尚未包含TLD。-为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。-在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。"><a href="#3-org-apache-jasper-servlet-TldScanner-scanJars-至少有一个JAR被扫描用于TLD但尚未包含TLD。-为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。-在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。" class="headerlink" title="3.org.apache.jasper.servlet.TldScanner.scanJars 至少有一个JAR被扫描用于TLD但尚未包含TLD。 为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。 在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。"></a>3.org.apache.jasper.servlet.TldScanner.scanJars 至少有一个JAR被扫描用于TLD但尚未包含TLD。 为此记录器启用调试日志记录，以获取已扫描但未在其中找到TLD的完整JAR列表。 在扫描期间跳过不需要的JAR可以缩短启动时间和JSP编译时间。</h3><p><strong>等级：</strong>警告</p>
<p><strong>解决方法:</strong></p>
<p><strong>1.修改 Tomcat 文件夹下 conf 文件夹中 logging.properties 文件</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 输出被扫描TLD的Jar包的列表</span></span><br><span class="line"><span class="meta">org.apache.jasper.servlet.TldScanner.level</span> = <span class="string">FINE</span></span><br></pre></td></tr></table></figure>

<p><strong>2.重新运行 Tomcat ，日志输出扫描的Jar包</strong></p>
<p><strong>3.修改 Tomcat 文件夹下 conf 文件夹中 catalina.properties 文件</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Default list of JAR files that should not be scanned using the JarScanner</span></span><br><span class="line"><span class="comment"># functionality. This is typically used to scan JARs for configuration</span></span><br><span class="line"><span class="comment"># information. JARs that do not contain such information may be excluded from</span></span><br><span class="line"><span class="comment"># the scan to speed up the scanning process. This is the default list. JARs on</span></span><br><span class="line"><span class="comment"># this list are excluded from all scans. The list must be a comma separated list</span></span><br><span class="line"><span class="comment"># of JAR file names.</span></span><br><span class="line"><span class="comment"># The list of JARs to skip may be over-ridden at a Context level for individual</span></span><br><span class="line"><span class="comment"># scan types by configuring a JarScanner with a nested JarScanFilter.</span></span><br><span class="line"><span class="comment"># The JARs listed below include:</span></span><br><span class="line"><span class="comment"># - Tomcat Bootstrap JARs</span></span><br><span class="line"><span class="comment"># - Tomcat API JARs</span></span><br><span class="line"><span class="comment"># - Catalina JARs</span></span><br><span class="line"><span class="comment"># - Jasper JARs</span></span><br><span class="line"><span class="comment"># - Tomcat JARs</span></span><br><span class="line"><span class="comment"># - Common non-Tomcat JARs</span></span><br><span class="line"><span class="comment"># - Test JARs (JUnit, Cobertura and dependencies)</span></span><br><span class="line"><span class="meta">tomcat.util.scan.StandardJarScanFilter.jarsToSkip</span>=<span class="string">\</span></span><br><span class="line">annotations-api.jar,\ant-junit*.jar,\ant-launcher.jar,\</span><br><span class="line">ant.jar,\asm-*.jar,\aspectj*.jar,\bootstrap.jar,\catalina-ant.jar,\catalina-ha.jar,\</span><br><span class="line">catalina-ssi.jar,\catalina-storeconfig.jar,\catalina-tribes.jar,\catalina.jar,\cglib-*.jar,\</span><br><span class="line">cobertura-*.jar,\commons-beanutils*.jar,\commons-codec*.jar,\commons-collections*.jar,\</span><br><span class="line">commons-daemon.jar,\commons-dbcp*.jar,\commons-digester*.jar,\</span><br><span class="line">commons-fileupload*.jar,\commons-httpclient*.jar,\commons-io*.jar,\commons-lang*.jar,\</span><br><span class="line">commons-logging*.jar,\commons-math*.jar,\commons-pool*.jar,\dom4j-*.jar,\easymock-*.jar,\</span><br><span class="line">ecj-*.jar,\el-api.jar,\geronimo-spec-jaxrpc*.jar,\h2*.jar,\hamcrest-*.jar,\hibernate*.jar,\</span><br><span class="line">httpclient*.jar,\icu4j-*.jar,\jasper-el.jar,\jasper.jar,\jaspic-api.jar,\jaxb-*.jar,\</span><br><span class="line">jaxen-*.jar,\jdom-*.jar,\jetty-*.jar,\jmx-tools.jar,\jmx.jar,\jsp-api.jar,\jstl.jar,\</span><br><span class="line">jta*.jar,\junit-*.jar,\junit.jar,\log4j*.jar,\mail*.jar,\objenesis-*.jar,\oraclepki.jar,\</span><br><span class="line">oro-*.jar,\servlet-api-*.jar,\servlet-api.jar,\slf4j*.jar,\taglibs-standard-spec-*.jar,\</span><br><span class="line">tagsoup-*.jar,\tomcat-api.jar,\tomcat-coyote.jar,\tomcat-dbcp.jar,\tomcat-i18n-*.jar,\</span><br><span class="line">tomcat-jdbc.jar,\tomcat-jni.jar,\tomcat-juli-adapters.jar,\tomcat-juli.jar,\tomcat-util-scan.jar,\</span><br><span class="line">tomcat-util.jar,\tomcat-websocket.jar,\tools.jar,\websocket-api.jar,\wsdl4j*.jar,\xercesImpl.jar,\</span><br><span class="line"><span class="attr">xml-apis.jar,\xmlParserAPIs-*.jar,\xmlParserAPIs.jar,\xom-*.jar</span></span><br><span class="line"><span class="comment"># 将要跳过扫描的包在后面添加</span></span><br><span class="line"><span class="comment"># 例子：mysql-connector-*.jar,\</span></span><br><span class="line"><span class="comment"># 注意以 ,\ 分隔</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/04/23/Tomcat%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" data-id="ckaq4osl40004cksm0twd0d2z" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/bug/" rel="tag">bug</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/tomcat/" rel="tag">tomcat</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Tomcat服务" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/04/23/Tomcat%E6%9C%8D%E5%8A%A1/" class="article-date">
  <time datetime="2020-04-23T04:22:00.000Z" itemprop="datePublished">2020-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/04/23/Tomcat%E6%9C%8D%E5%8A%A1/">Tomcat 服务</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>运行环境：Windows 10 | Apache Tomcat 9.0.34 | 博客记录时间：2020-4-23 17:16:12</p>
<p>通常我们 打开 / 关闭 Tomcat 服务时都会执行bin目录下的 startup.bat / shutdown.bat 文件。</p>
<p>但是细心的小伙伴就会发现(╮(￣▽￣)╭)，<code>startup.bat</code> 和 <code>shutdown.bat</code> 文件中都有这么一句话。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rem ---------------------------------------------------------------------------</span><br><span class="line">rem Start / Stop script <span class="keyword">for</span> the CATALINA Server</span><br><span class="line">rem ---------------------------------------------------------------------------</span><br><span class="line">call <span class="string">"%EXECUTABLE%"</span> start / stop %CMD_LINE_ARGS%</span><br></pre></td></tr></table></figure>

<p>所以不论是 startup 还是 shutdown 都是执行了 <code>catalina.bat</code>，只是执行的指令不同。</p>
<h3 id="catalina-bat"><a href="#catalina-bat" class="headerlink" title="catalina.bat"></a>catalina.bat</h3><p>首选我们分析下 <code>catalina.bat</code> 脚本的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rem Guess CATALINA_HOME <span class="keyword">if</span> not defined</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CURRENT_DIR=%cd%"</span></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%CATALINA_HOME%"</span> == <span class="string">""</span> goto gotHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CATALINA_HOME=%CURRENT_DIR%"</span></span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\catalina.bat"</span> goto okHome</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CATALINA_HOME=%cd%"</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">"%CURRENT_DIR%"</span></span><br></pre></td></tr></table></figure>

<p>检验 CATALINA_HOME 环境变量，如果不正确则重新设置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> CLASSPATH=</span><br><span class="line"></span><br><span class="line">rem Get standard environment variables</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\bin\setenv.bat"</span> goto checkSetenvHome</span><br><span class="line">call <span class="string">"%CATALINA_BASE%\bin\setenv.bat"</span></span><br><span class="line">goto setenvDone</span><br><span class="line">:checkSetenvHome</span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\setenv.bat"</span> call <span class="string">"%CATALINA_HOME%\bin\setenv.bat"</span></span><br><span class="line">:setenvDone</span><br><span class="line"></span><br><span class="line">rem Get standard Java environment variables</span><br><span class="line"><span class="keyword">if</span> exist <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span> goto okSetclasspath</span><br><span class="line"><span class="built_in">echo</span> Cannot find <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span></span><br><span class="line"><span class="built_in">echo</span> This file is needed to run this program</span><br><span class="line">goto end</span><br><span class="line">:okSetclasspath</span><br><span class="line">call <span class="string">"%CATALINA_HOME%\bin\setclasspath.bat"</span> %1</span><br><span class="line"><span class="keyword">if</span> errorlevel 1 goto end</span><br></pre></td></tr></table></figure>

<p>设置环境变量：</p>
<ul>
<li>在 CATALINA_BASE 和 CATALINA_BASE 寻找<code>setenv.bat</code>文件并执行，找不到则不执行。</li>
<li>寻找<code>setclasspath.bat</code>(设置 Java 相关的环境变量)文件并执行，找不到则结束。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">rem Add tomcat-juli.jar to classpath</span><br><span class="line">rem tomcat-juli.jar can be over-ridden per instance</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\bin\tomcat-juli.jar"</span> goto juliClasspathHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CLASSPATH=%CLASSPATH%;%CATALINA_BASE%\bin\tomcat-juli.jar"</span></span><br><span class="line">goto juliClasspathDone</span><br><span class="line">:juliClasspathHome</span><br><span class="line"><span class="built_in">set</span> <span class="string">"CLASSPATH=%CLASSPATH%;%CATALINA_HOME%\bin\tomcat-juli.jar"</span></span><br><span class="line">:juliClasspathDone</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JSSE_OPTS%"</span> == <span class="string">""</span> goto gotJsseOpts</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JSSE_OPTS=-Djdk.tls.ephemeralDHKeySize=2048"</span></span><br><span class="line">:gotJsseOpts</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JAVA_OPTS=%JAVA_OPTS% %JSSE_OPTS%"</span></span><br><span class="line"></span><br><span class="line">rem Register custom URL handlers</span><br><span class="line">rem Do this here so custom URL handles (specifically <span class="string">'war:...'</span>) can be used <span class="keyword">in</span> the security policy</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JAVA_OPTS=%JAVA_OPTS% -Djava.protocol.handler.pkgs=org.apache.catalina.webresources"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%LOGGING_CONFIG%"</span> == <span class="string">""</span> goto noJuliConfig</span><br><span class="line"><span class="built_in">set</span> LOGGING_CONFIG=-Dnop</span><br><span class="line"><span class="keyword">if</span> not exist <span class="string">"%CATALINA_BASE%\conf\logging.properties"</span> goto noJuliConfig</span><br><span class="line"><span class="built_in">set</span> LOGGING_CONFIG=-Djava.util.logging.config.file=<span class="string">"%CATALINA_BASE%\conf\logging.properties"</span></span><br><span class="line">:noJuliConfig</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%LOGGING_MANAGER%"</span> == <span class="string">""</span> goto noJuliManager</span><br><span class="line"><span class="built_in">set</span> LOGGING_MANAGER=-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager</span><br><span class="line">:noJuliManager</span><br></pre></td></tr></table></figure>

<p>tomcat-juli.jar：</p>
<ul>
<li>将 <strong>tomcat-juli.jar</strong> 添加到 classPath 环境变量中。</li>
<li>将日志的配置文件路径添加到 LOGGING_CONFIG 环境变量中。</li>
</ul>
<blockquote>
<p>Apache Tomcat由一个自己的实现了 java.util.logging 多个关键元素的实现。这个实现被称为 JULI 。实现的核心组件是定制化的 LogManager ，可以获取运行在Tomcat中的不同web应用(以及不同的class loader)。他支持为应用配置单独的日志配置。当有web应用从内在中是被卸载时，会接到Tomcat的通知，以便他所引用的类可以被清除，避免内存泄露。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">rem Execute The Requested Command</span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_BASE:   <span class="string">"%CATALINA_BASE%"</span></span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_HOME:   <span class="string">"%CATALINA_HOME%"</span></span><br><span class="line"><span class="built_in">echo</span> Using CATALINA_TMPDIR: <span class="string">"%CATALINA_TMPDIR%"</span></span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>debug<span class="string">""</span> goto use_jdk</span><br><span class="line"><span class="built_in">echo</span> Using JRE_HOME:        <span class="string">"%JRE_HOME%"</span></span><br><span class="line">goto java_dir_displayed</span><br><span class="line">:use_jdk</span><br><span class="line"><span class="built_in">echo</span> Using JAVA_HOME:       <span class="string">"%JAVA_HOME%"</span></span><br><span class="line">:java_dir_displayed</span><br><span class="line"><span class="built_in">echo</span> Using CLASSPATH:       <span class="string">"%CLASSPATH%"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> _EXECJAVA=%_RUNJAVA%</span><br><span class="line"><span class="built_in">set</span> MAINCLASS=org.apache.catalina.startup.Bootstrap</span><br><span class="line"><span class="built_in">set</span> ACTION=start</span><br><span class="line"><span class="built_in">set</span> SECURITY_POLICY_FILE=</span><br><span class="line"><span class="built_in">set</span> DEBUG_OPTS=</span><br><span class="line"><span class="built_in">set</span> JPDA=</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> not <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>jpda<span class="string">""</span> goto noJpda</span><br><span class="line"><span class="built_in">set</span> JPDA=jpda</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_TRANSPORT%"</span> == <span class="string">""</span> goto gotJpdaTransport</span><br><span class="line"><span class="built_in">set</span> JPDA_TRANSPORT=dt_socket</span><br><span class="line">:gotJpdaTransport</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_ADDRESS%"</span> == <span class="string">""</span> goto gotJpdaAddress</span><br><span class="line"><span class="built_in">set</span> JPDA_ADDRESS=localhost:8000</span><br><span class="line">:gotJpdaAddress</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_SUSPEND%"</span> == <span class="string">""</span> goto gotJpdaSuspend</span><br><span class="line"><span class="built_in">set</span> JPDA_SUSPEND=n</span><br><span class="line">:gotJpdaSuspend</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JPDA_OPTS%"</span> == <span class="string">""</span> goto gotJpdaOpts</span><br><span class="line"><span class="built_in">set</span> JPDA_OPTS=-agentlib:jdwp=transport=%JPDA_TRANSPORT%,address=%JPDA_ADDRESS%,server=y,<span class="built_in">suspend</span>=%JPDA_SUSPEND%</span><br><span class="line">:gotJpdaOpts</span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line">:noJpda</span><br></pre></td></tr></table></figure>

<ul>
<li>设置启动类 - org.apache.catalina.startup.Bootstrap</li>
<li>设置远程调试相关参数 - JPDA</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>debug<span class="string">""</span> goto doDebug</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>run<span class="string">""</span> goto doRun</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>start<span class="string">""</span> goto doStart</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>stop<span class="string">""</span> goto doStop</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>configtest<span class="string">""</span> goto doConfigTest</span><br><span class="line"><span class="keyword">if</span> <span class="string">""</span>%1<span class="string">""</span> == <span class="string">""</span>version<span class="string">""</span> goto doVersion</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> Usage:  catalina ( commands ... )</span><br><span class="line"><span class="built_in">echo</span> commands:</span><br><span class="line"><span class="built_in">echo</span>   debug             Start Catalina <span class="keyword">in</span> a debugger</span><br><span class="line"><span class="built_in">echo</span>   debug -security   Debug Catalina with a security manager</span><br><span class="line"><span class="built_in">echo</span>   jpda start        Start Catalina under JPDA debugger</span><br><span class="line"><span class="built_in">echo</span>   run               Start Catalina <span class="keyword">in</span> the current window</span><br><span class="line"><span class="built_in">echo</span>   run -security     Start <span class="keyword">in</span> the current window with security manager</span><br><span class="line"><span class="built_in">echo</span>   start             Start Catalina <span class="keyword">in</span> a separate window</span><br><span class="line"><span class="built_in">echo</span>   start -security   Start <span class="keyword">in</span> a separate window with security manager</span><br><span class="line"><span class="built_in">echo</span>   stop              Stop Catalina</span><br><span class="line"><span class="built_in">echo</span>   configtest        Run a basic syntax check on server.xml</span><br><span class="line"><span class="built_in">echo</span>   version           What version of tomcat are you running?</span><br><span class="line">goto end</span><br></pre></td></tr></table></figure>

<p>这里值得注意的且常用的(start / stop)，正如开头提到的。</p>
<h3 id="org-apache-catalina"><a href="#org-apache-catalina" class="headerlink" title="org.apache.catalina"></a>org.apache.catalina</h3><p>解压 bin 目录中的 catalina.jar 后我们能找到 org.apache.catalina.startup.Bootstrap 也就是 catalina.bat 里设置的启动类(MAINCLASS)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Bootstrap</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">        String command = <span class="string">"start"</span>;</span><br><span class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            command = args[args.length - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (command.equals(<span class="string">"start"</span>)) &#123;</span><br><span class="line">            daemon.setAwait(<span class="keyword">true</span>);</span><br><span class="line">            daemon.load(args);</span><br><span class="line">            daemon.start();</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == daemon.getServer()) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command.equals(<span class="string">"stop"</span>)) &#123;</span><br><span class="line">                daemon.stopServer(args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当指令等于<code>start</code>时运行 Catalina.class 中的 <code>start()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.startup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Catalina</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// --- 略 ---</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.await) &#123;</span><br><span class="line">            <span class="keyword">this</span>.await();</span><br><span class="line">            <span class="keyword">this</span>.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>start()</code>方法中调用了<code>await()</code>和<code>stop()</code>两个方法：</p>
<ul>
<li><p><code>await()</code> 方法监听停止服务请求的方法</p>
</li>
<li><p><code>stop()</code> 方法是停止服务的方法</p>
</li>
</ul>
<blockquote>
<p><code>await()</code> 方法是阻塞方法，只有客户端请求关闭Tomcat服务时，他才会执行<code>stop()</code>方法，否则一直等待关闭请求。</p>
</blockquote>
<p>StandardServer.class 中的 <code>await()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.catalina.core;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardServer</span> <span class="keyword">extends</span> <span class="title">LifecycleMBeanBase</span> <span class="keyword">implements</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServerSocket awaitSocket = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> String shutdown = <span class="string">"SHUTDOWN"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">await</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.awaitSocket = <span class="keyword">new</span> ServerSocket(<span class="keyword">this</span>.getPortWithOffset(), <span class="number">1</span>,InetAddress.getByName(<span class="keyword">this</span>.address));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var67) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"standardServer.awaitSocket.fail"</span>, <span class="keyword">new</span> Object[]&#123;<span class="keyword">this</span>.address,String.valueOf(<span class="keyword">this</span>.getPortWithOffset()), String.valueOf(<span class="keyword">this</span>.getPort()),String.valueOf(<span class="keyword">this</span>.getPortOffset())&#125;), var67);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ServerSocket serverSocket;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/* 略 */</span></span><br><span class="line">             <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">                 label611: &#123;</span><br><span class="line">                     label610: &#123;</span><br><span class="line">                         <span class="keyword">try</span> &#123;</span><br><span class="line">                             label634: &#123;</span><br><span class="line">                                 <span class="keyword">try</span> &#123;</span><br><span class="line">                                     <span class="comment">// 执行accept等待请求</span></span><br><span class="line">                                     socket = serverSocket.accept();</span><br><span class="line">                                     socket.setSoTimeout(<span class="number">10000</span>);</span><br><span class="line">                                     stream = socket.getInputStream();</span><br><span class="line">                                 &#125; <span class="keyword">catch</span> (SocketTimeoutException var69) &#123;</span><br><span class="line">                                     log.warn(sm.getString(<span class="string">"standardServer.accept.timeout"</span>, <span class="keyword">new</span> Object[]&#123;System.currentTimeMillis() - acceptStartTime&#125;), var69);</span><br><span class="line">                                     <span class="keyword">continue</span>;</span><br><span class="line">                                 &#125;</span><br><span class="line">                                 <span class="comment">/* 略 */</span></span><br><span class="line">                             &#125;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">                 &#125;</span><br><span class="line">                 <span class="comment">/* 略 */</span></span><br><span class="line">                 <span class="keyword">boolean</span> match = command.toString().equals(<span class="keyword">this</span>.shutdown);</span><br><span class="line">                 <span class="comment">// 如果请求内容与 shutdown 字段相同则跳出循环，Socket 服务停止</span></span><br><span class="line">                 <span class="keyword">if</span> (match) &#123;</span><br><span class="line">                     log.info(sm.getString(<span class="string">"standardServer.shutdownViaPort"</span>));</span><br><span class="line">                     var32 = <span class="keyword">false</span>;</span><br><span class="line">                     <span class="keyword">break</span>;</span><br><span class="line">                 &#125;</span><br><span class="line">                 log.warn(sm.getString(<span class="string">"standardServer.invalidShutdownCommand"</span>, <span class="keyword">new</span> Object[]&#123;command.toString()&#125;));</span><br><span class="line">             &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里开启了一个 ServerSocket ，调用 accept() 方法监听请求。</p>
<p><code>serverSocket.close()</code>之后 <code>start()</code>方法中的<code>this.stop()</code>执行，Server 被关闭。</p>
<p>当指令等于<code>stop</code>时运行 Catalina.class 中的 <code>stopServer()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stopServer</span><span class="params">(String[] arguments)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (arguments != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.arguments(arguments);</span><br><span class="line">    &#125;</span><br><span class="line">    Server s = <span class="keyword">this</span>.getServer();</span><br><span class="line">    <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">/* 略 */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            s.stop();</span><br><span class="line">            s.destroy();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (LifecycleException var63) &#123;</span><br><span class="line">            log.error(sm.getString(<span class="string">"catalina.stopError"</span>), var63);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>显而易见，Server 不为 null 时，停止并且销毁。</p>
<h3 id="Server-中的-shutdown-属性"><a href="#Server-中的-shutdown-属性" class="headerlink" title="Server 中的 shutdown 属性"></a>Server 中的 shutdown 属性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8085"</span> shutdown=<span class="string">"SHUTDOWN"</span>&gt;</span><br></pre></td></tr></table></figure>

<p>这里<code>shutdown</code>的默认属性就是<code>SHUTDOWN</code>，与 StandardServer 类中 shutdown 属性的值一样。</p>
<blockquote>
<p>当然 StandardServer 类中 shutdown 属性提供了 setShutdown(String shutdown) 方法。</p>
</blockquote>
<p>做个测试，我们执行 startup.bat 先启动 Tomcat ，跳出窗口并打印日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Tomcat</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat/9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│<span class="comment"># 略</span></span><br><span class="line">│Server startup <span class="keyword">in</span> [673] milliseconds</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>我们再启动另一个窗口，进入<code>telnet</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Command Prompt</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Microsoft Windows [版本 10.0.17763.1039]</span><br><span class="line">│(c) 2018 Microsoft Corporation。保留所有权利。</span><br><span class="line">│C:\Users\Administrator&gt;telnet localhost 8005</span><br><span class="line">│正在连接localhost...</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>之后我们再像8005端口发送点东西</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Telnet localhost</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│unshell</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>发送<code>unshell</code>字符串，Tomcat窗口打印出新的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Tomcat</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat&#x2F;9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│# 略</span><br><span class="line">│Server startup in [673] milliseconds</span><br><span class="line">│Invalid shutdown command [unshell] received</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>如果内容没有更新可以尝试按<code>enter</code>键</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 完整内容如下(可以看到警告的方法，就如我们之前所说的那样)</span><br><span class="line"><span class="number">23</span>-Apr-<span class="number">2020</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">20</span><span class="variable">.166</span> 警告 [main] org<span class="variable">.apache</span><span class="variable">.catalina</span><span class="variable">.core</span><span class="variable">.StandardServer</span><span class="variable">.await</span> Invalid shutdown command [unshell] received</span><br></pre></td></tr></table></figure>

<p>所以当我们输入指令为<code>SHUTDOWN</code>时，Tomcat 就关闭了。</p>
<p>当然这个指令默认监听<code>localhost</code>的关闭请求，如果要支持远程关闭的话，可以添加参数 address，例子如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Server port=<span class="string">"8085"</span> shutdown=<span class="string">"SHUTDOWN"</span> address=<span class="string">"36.152.44.95"</span>&gt;</span><br></pre></td></tr></table></figure>

<p>具体版本是否支持该参数，运行 Tomcat ，文档在 <code>http://localhost:8080/docs/config/server.html</code>中有说明。</p>
<p>这里以版本9为例</p>
<p>All implementations of <strong>Server</strong> support the following attributes：</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>port</td>
<td>The TCP/IP port number on which this server waits for a shutdown command. Set to <code>-1</code> to disable the shutdown port.</td>
</tr>
<tr>
<td>shutdown</td>
<td>The command string that must be received via a TCP/IP connection to the specified port number, in order to shut down Tomcat.</td>
</tr>
<tr>
<td>address</td>
<td>The TCP/IP address on which this server waits for a shutdown command. If no address is specified, <code>localhost</code> is used.</td>
</tr>
</tbody></table>
<blockquote>
<p>以上就是所有内容，本文只是在理解 Tomcat 时，碰巧看到的一些边缘内容，作为记录保存下来。</p>
</blockquote>
<h3 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h3><ul>
<li><p><a href="https://www.jianshu.com/p/b2f63ffa964c" target="_blank" rel="noopener">Tomcat catalina.bat 原理解析</a></p>
</li>
<li><p><a href="https://cloud.tencent.com/developer/article/1129737" target="_blank" rel="noopener">Tomcat 怎么停止服务的?</a></p>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/04/23/Tomcat%E6%9C%8D%E5%8A%A1/" data-id="ckaq4osl90009cksmdk2p5nc7" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/tomcat/" rel="tag">tomcat</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-快速使用Tomcat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/04/23/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8Tomcat/" class="article-date">
  <time datetime="2020-04-23T00:44:09.000Z" itemprop="datePublished">2020-04-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/04/23/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8Tomcat/">快速使用 Tomcat</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>运行环境：Windows 10 | Apache Tomcat 9.0.34 | Java 1.8.0 | 博客记录时间：2020-4-23 08:59:27</p>
<h3 id="下载-Tomcat"><a href="#下载-Tomcat" class="headerlink" title="下载 Tomcat"></a>下载 Tomcat</h3><p>首先进入到 <a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat官网</a> ，这里我们以 <a href="https://tomcat.apache.org/download-90.cgi" target="_blank" rel="noopener">版本9</a> 进行举例 (目前最新版本为10)。</p>
<h3 id="9-0-34"><a href="#9-0-34" class="headerlink" title="9.0.34"></a>9.0.34</h3><h4 id="Binary-Distributions"><a href="#Binary-Distributions" class="headerlink" title="Binary Distributions"></a>Binary Distributions</h4><ul>
<li>Core:<ul>
<li><a href="https://mirror.bit.edu.cn/apache/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.zip" target="_blank" rel="noopener">zip</a> (<a href="https://downloads.apache.org/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.zip.asc" target="_blank" rel="noopener">pgp</a>, <a href="https://downloads.apache.org/tomcat/tomcat-9/v9.0.34/bin/apache-tomcat-9.0.34.zip.sha512" target="_blank" rel="noopener">sha512</a>)</li>
</ul>
</li>
</ul>
<p>这里我们直接点击 zip 下载，下载完之后文件目录如下：</p>
<ul>
<li>apache-tomcat-9.0.34<ul>
<li>bin - 运行文件，Windows环境下的.bat和Linux环境下的.sh</li>
<li>conf - 常用到的一些配置文件</li>
<li>lib - 一些 Java 的 Jar 包</li>
<li>logs - 日志</li>
<li>temp - 临时文件</li>
<li>webapps - 默认虚拟主机的默认项目根目录</li>
<li>work - 项目部署后的缓存文件目录</li>
</ul>
</li>
</ul>
<p>除了以前的文件夹外还有一些文件，如 README.md 文件</p>
<blockquote>
<p>官网：Please see the README file for packaging information. It explains what every distribution contains. </p>
</blockquote>
<h3 id="运行-Tomcat"><a href="#运行-Tomcat" class="headerlink" title="运行 Tomcat"></a>运行 Tomcat</h3><p>我们可以看到 webapps 目录下有5个初始项目：</p>
<ul>
<li>webapps<ul>
<li>docs</li>
<li>examples</li>
<li>host-manager</li>
<li>manager</li>
<li>ROOT</li>
</ul>
</li>
</ul>
<blockquote>
<p>Tomcat 中 bin 和 lib 文件中的 Jar 包说明了需要在 Java 环境下运行</p>
</blockquote>
<p>然后我们运行 bin 目录下的 startup.bat 文件，如果出现终端窗口一直在打印日志说明运行成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Command Prompt</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Server.服务器版本:Apache Tomcat&#x2F;9.0.34</span><br><span class="line">│服务器构建:Apr 3 2020 2020 12:02:52 UTC</span><br><span class="line">│服务器版本号(:9.0.34.0</span><br><span class="line">│OS Name:Windows 10</span><br><span class="line">│OS.版本:10.0</span><br><span class="line">│架构:amd64</span><br><span class="line">│Java 环境变量: C:\Program Files\Java\jdk1.8.0_251\jre</span><br><span class="line">│JVM 版本:1.8.0_251-b08</span><br><span class="line">│JVM.供应商:Oracle Corporation</span><br><span class="line">│--- 略 ---</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>打印的内容大致如上，这时候使用浏览器访问 <code>localhost:8080</code>，就能看到 Tomcat 的如下页面：</p>
<p><img src="/blog/css/images/article/tomcat/01.png" alt="webapps 目录下的 ROOT 项目"></p>
<blockquote>
<p>值得注意的是 work 目录中生成了对应项目的文件夹，但内容为空。以及 logs 文件中生成的日志文件，如 catalina.*.log 中的内容就是终端窗口打印的内容。</p>
</blockquote>
<h3 id="日志输出乱码问题"><a href="#日志输出乱码问题" class="headerlink" title="日志输出乱码问题"></a>日志输出乱码问题</h3><p>当窗口运行时输出的日志出现乱码，如<code>淇℃伅</code>之类的内容说明当前系统的默认字符与 conf 文件夹中 logging.properties 文件中 encoding 属性设置不相同(默认配置为UTF-8)。</p>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">┌────────────────────────────────────────────────────────┐</span><br><span class="line">│Command Prompt</span><br><span class="line">├────────────────────────────────────────────────────────┤</span><br><span class="line">│Microsoft Windows [版本 10.0.17763.1039]</span><br><span class="line">│(c) 2018 Microsoft Corporation。保留所有权利。</span><br><span class="line">│C:\Users\Administrator&gt;chcp</span><br><span class="line">│活动代码页: 936</span><br><span class="line">└────────────────────────────────────────────────────────┘</span><br></pre></td></tr></table></figure>

<p>获取当前系统活动代码页，找到对应编码，如下表：</p>
<table>
<thead>
<tr>
<th>活动代码页</th>
<th>编码</th>
</tr>
</thead>
<tbody><tr>
<td>936</td>
<td>简体中文(GBK)</td>
</tr>
<tr>
<td>65001</td>
<td>UTF-8Unicode</td>
</tr>
</tbody></table>
<p>然后修改 logging.properties 中 encoding = GBK，如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="comment"># Handler specific properties.</span></span><br><span class="line"><span class="comment"># Describes specific configuration info for Handlers.</span></span><br><span class="line"><span class="comment">############################################################</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.level</span> = <span class="string">FINE</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.directory</span> = <span class="string">$&#123;catalina.base&#125;/logs</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.prefix</span> = <span class="string">catalina.</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.maxDays</span> = <span class="string">90</span></span><br><span class="line"><span class="meta">1catalina.org.apache.juli.AsyncFileHandler.encoding</span> = <span class="string">GBK</span></span><br></pre></td></tr></table></figure>

<h3 id="发布项目"><a href="#发布项目" class="headerlink" title="发布项目"></a>发布项目</h3><h4 id="1-添加-war-包到-webapps-中"><a href="#1-添加-war-包到-webapps-中" class="headerlink" title="1.添加 war 包到 webapps 中"></a>1.添加 war 包到 webapps 中</h4><ul>
<li>webapps<ul>
<li>FlogShiro.war</li>
</ul>
</li>
</ul>
<h4 id="2-执行-startup-bat-文件-如之前在执行状态先执行-shutdown-bat-文件"><a href="#2-执行-startup-bat-文件-如之前在执行状态先执行-shutdown-bat-文件" class="headerlink" title="2.执行 startup.bat 文件 (如之前在执行状态先执行 shutdown.bat 文件)"></a>2.执行 startup.bat 文件 (如之前在执行状态先执行 shutdown.bat 文件)</h4><p>打印出日志，并且在webapps中解压war，多出项目文件夹：</p>
<ul>
<li>webapps<ul>
<li>FlogShiro (解压的项目文件)</li>
<li>FlogShiro.war</li>
</ul>
</li>
</ul>
<h4 id="3-访问网站"><a href="#3-访问网站" class="headerlink" title="3.访问网站"></a>3.访问网站</h4><p><code>localhost:8080/FlogShiro/index.html</code></p>
<p>默认监听端口为<code>8080</code>，项目名为FlogShiro，展示页面为index.html</p>
<blockquote>
<p>具体内容根据实际情况决定</p>
</blockquote>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>目前我们还没提到 conf 文件夹，以发布项目中的例子查看 conf &gt; server.xml 文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 删除注解后内容如下 --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"SHUTDOWN"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.startup.VersionLoggerListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.AprLifecycleListener"</span> <span class="attr">SSLEngine</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.JreMemoryLeakPreventionListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.mbeans.GlobalResourcesLifecycleListener"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">Listener</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.core.ThreadLocalLeakPreventionListener"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Resource</span> <span class="attr">name</span>=<span class="string">"UserDatabase"</span> <span class="attr">auth</span>=<span class="string">"Container"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">type</span>=<span class="string">"org.apache.catalina.UserDatabase"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">description</span>=<span class="string">"User database that can be updated and saved"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">factory</span>=<span class="string">"org.apache.catalina.users.MemoryUserDatabaseFactory"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">pathname</span>=<span class="string">"conf/tomcat-users.xml"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">GlobalNamingResources</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">"Catalina"</span> <span class="attr">defaultHost</span>=<span class="string">"localhost"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.LockOutRealm"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Realm</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.realm.UserDatabaseRealm"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">resourceName</span>=<span class="string">"UserDatabase"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Realm</span>&gt;</span></span><br><span class="line"></span><br><span class="line">      <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">"localhost"</span>  <span class="attr">appBase</span>=<span class="string">"webapps"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">"true"</span> <span class="attr">autoDeploy</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Valve</span> <span class="attr">className</span>=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> <span class="attr">directory</span>=<span class="string">"logs"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">prefix</span>=<span class="string">"localhost_access_log"</span> <span class="attr">suffix</span>=<span class="string">".txt"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">pattern</span>=<span class="string">"%h %l %u %t <span class="symbol">&amp;quot;</span>%r<span class="symbol">&amp;quot;</span> %s %b"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里我们值得注意的就是 <code>Server</code>、<code>Service</code> 和 <code>Connector</code> 以及 <code>Host</code></p>
<ul>
<li>Server<ul>
<li>port （服务器监听端口）</li>
<li>shutdown (关闭指令)</li>
</ul>
</li>
<li>Service<ul>
<li>name (服务名)</li>
</ul>
</li>
<li>Connector<ul>
<li>port (服务监听端口)</li>
<li>protocol (协议类型)</li>
<li>connectionTimeout (连接超时)</li>
<li>redirectPort (端口重定向)</li>
</ul>
</li>
<li>Host<ul>
<li>name (虚拟主机名称)</li>
<li>appBase (项目根目录)</li>
<li>unpackWARs (解压War包)</li>
<li>autoDeploy (自动部署)</li>
</ul>
</li>
</ul>
<p>显而易见，以发布项目的例子可以看出名为 localhost 的虚拟主机的根目录为 webapps ，并且配置了解压 war 包，Service监听的端口为 <code>8080</code> 。</p>
<p>所以当我们访问 <code>localhost:8080</code> 访问到了 webapps 目录下的ROOT，而访问 <code>localhost:8080/FlogShiro</code> 则访问到了指定FlogShiro项目。</p>
<h3 id="虚拟主机"><a href="#虚拟主机" class="headerlink" title="虚拟主机"></a>虚拟主机</h3><p>为什么我们访问 <code>localhost</code> 和 <code>127.0.0.1</code> 访问到的东西是一样，因为本机已经做好了IP和域名的本地映射</p>
<p>找到 C:\Windows\System32\drivers\etc 中的<code>hosts</code>文件(C为系统盘)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># Copyright (c) 1993-2009 Microsoft Corp.</span><br><span class="line">#</span><br><span class="line"># This is a sample HOSTS file used by Microsoft TCP&#x2F;IP for Windows.</span><br><span class="line">#</span><br><span class="line"># This file contains the mappings of IP addresses to host names. Each</span><br><span class="line"># entry should be kept on an individual line. The IP address should</span><br><span class="line"># be placed in the first column followed by the corresponding host name.</span><br><span class="line"># The IP address and the host name should be separated by at least one</span><br><span class="line"># space.</span><br><span class="line">#</span><br><span class="line"># Additionally, comments (such as these) may be inserted on individual</span><br><span class="line"># lines or following the machine name denoted by a &#39;#&#39; symbol.</span><br><span class="line">#</span><br><span class="line"># For example:</span><br><span class="line">#</span><br><span class="line">#      102.54.94.97     rhino.acme.com          # source server</span><br><span class="line">#       38.25.63.10     x.acme.com              # x client host</span><br><span class="line"></span><br><span class="line"># localhost name resolution is handled within DNS itself.</span><br><span class="line"># 本地主机名称解析是在DNS本身内处理的。</span><br><span class="line">#	127.0.0.1       localhost</span><br><span class="line">#	::1             localhost</span><br></pre></td></tr></table></figure>

<p>你可以按照上面的 <code>example</code> 添加虚拟主机名称，这样Tomcat配置文件夹下server.xml中Host属性name可以使用添加的主机名称。</p>
<blockquote>
<p>当然如果你不想在 webapps 中添加项目，你也可以新添加的主机中配置其他文件夹问根目录。</p>
<p>注意：在访问中(具体得看实际情况)，webapps 中可能存在一些会发生冲突的项目名，如 manager</p>
</blockquote>
<h3 id="更多内容"><a href="#更多内容" class="headerlink" title="更多内容"></a>更多内容</h3><ul>
<li></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/04/23/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8Tomcat/" data-id="ckaq4osld000gcksm8qtof5mk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/fast/" rel="tag">fast</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/tomcat/" rel="tag">tomcat</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-正则表达式" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/04/22/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="article-date">
  <time datetime="2020-04-22T00:57:16.000Z" itemprop="datePublished">2020-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/04/22/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">正则表达式</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>虽然正则内容不算很多但是用好正则还是得花一些时间的，这篇文章只是做简单的记录</p>
</blockquote>
<h3 id="运算符类型"><a href="#运算符类型" class="headerlink" title="运算符类型"></a>运算符类型</h3><ul>
<li>转义符 <code>/</code> </li>
<li>圆括号和方括号 <code>()</code> 、<code>[]</code> </li>
<li>限定符 <code>*</code> 、<code>+</code> 、<code>?</code> 、<code>{n}</code>、<code>{n,}</code>、<code>{n,m}</code> </li>
<li>定位点和序列 <code>^</code> 、<code>$</code> 、<code>\</code> </li>
<li>替换，或操作 <code>|</code> </li>
</ul>
<h3 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h3><p>以JavaScript为例使用正则的方法：</p>
<ul>
<li>/[a-z]*/</li>
<li>^[a-z]*$</li>
</ul>
<p>圆括号相当于子表达式，类似组的概念可以被重复使用</p>
<ul>
<li>/\b([a-z]+) \1\b/</li>
<li>/\b([a-z]+) ([a-z]+)\b/</li>
</ul>
<p>两者效果一样</p>
<p><code>^</code>虽然为定位符，但是在<code>[]</code>中起到非的作用</p>
<h3 id="推荐网站"><a href="#推荐网站" class="headerlink" title="推荐网站"></a>推荐网站</h3><ul>
<li><a href="https://regexper.com/" target="_blank" rel="noopener">以SVG的样式展示正则的规则</a></li>
<li><a href="https://regex101.com/" target="_blank" rel="noopener">比较实用的正则检测网站</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/04/22/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" data-id="ckaq4oslc000ecksm6ykh438g" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/regex/" rel="tag">regex</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CentOs安装MySql" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/04/21/CentOs%E5%AE%89%E8%A3%85MySql/" class="article-date">
  <time datetime="2020-04-21T07:10:18.000Z" itemprop="datePublished">2020-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/04/21/CentOs%E5%AE%89%E8%A3%85MySql/">CentOs 安装 MySql</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h2><p>系统：CentOS Linux release 8.1.1911 (Core) | MySQL版本：8.0.17 | 博客记录时间：2020-4-21 15:21:36</p>
<blockquote>
<p>为了方便这里从有到无，在从无到有的流程进行记录</p>
</blockquote>
<h2 id="卸载MySQL"><a href="#卸载MySQL" class="headerlink" title="卸载MySQL"></a>卸载MySQL</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接切换成root账号,避免权限不足造成其他问题</span></span><br><span class="line">[unshell@localhost /]$ su root</span><br><span class="line">Password: </span><br><span class="line">[root@localhost /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h3 id="移除防火墙端口"><a href="#移除防火墙端口" class="headerlink" title="移除防火墙端口"></a>移除防火墙端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检查防火墙状态</span></span><br><span class="line">systemctl status firewalld</span><br><span class="line"><span class="comment"># 如果显示内容如下-active(running),说明防火墙在运行状态</span></span><br><span class="line">● firewalld.service - firewalld - dynamic firewall daemon</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/firewalld.service; enabled; vendor p&gt;</span><br><span class="line">   Active: active (running) since Tue 2020-04-21 10:39:58 CST; 4h 53min ago</span><br><span class="line">     Docs: man:firewalld(1)</span><br><span class="line"> Main PID: 1012 (firewalld)</span><br><span class="line">    Tasks: 3 (<span class="built_in">limit</span>: 4888)</span><br><span class="line">   Memory: 8.8M</span><br><span class="line">   CGroup: /system.slice/firewalld.service</span><br><span class="line">           └─1012 /usr/libexec/platform-python -s /usr/sbin/firewalld --nofork &gt;</span><br><span class="line"><span class="comment"># 移除MySql默认端口3306</span></span><br><span class="line">firewall-cmd --permanent --remove-port=3306/tcp</span><br><span class="line"><span class="comment"># 输出success说明成功</span></span><br><span class="line">success</span><br><span class="line"><span class="comment"># 重启防火墙后生效</span></span><br><span class="line">systemctl reload firewalld</span><br></pre></td></tr></table></figure>

<h3 id="关闭MySQl服务，删除MySQl相关包与文件夹"><a href="#关闭MySQl服务，删除MySQl相关包与文件夹" class="headerlink" title="关闭MySQl服务，删除MySQl相关包与文件夹"></a>关闭MySQl服务，删除MySQl相关包与文件夹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 关闭MySQL服务</span></span><br><span class="line">systemctl stop mysqld</span><br><span class="line"><span class="comment"># 查找已安装的MySQl相关的包</span></span><br><span class="line">rpm -qa|grep -i mysql</span><br><span class="line"><span class="comment"># 移除输出的包</span></span><br><span class="line">yum remove package</span><br><span class="line"><span class="comment"># 查询相关的文件夹</span></span><br><span class="line">find / -name mysql</span><br><span class="line"><span class="comment"># 删除输出的文件夹</span></span><br><span class="line">rm -rf directory</span><br></pre></td></tr></table></figure>

<h2 id="安装MySQL"><a href="#安装MySQL" class="headerlink" title="安装MySQL"></a>安装MySQL</h2><p>查看MySQL <a href="https://www.mysql.com/" target="_blank" rel="noopener">官网</a> 提供的 <a href="https://dev.mysql.com/downloads/repo/yum/" target="_blank" rel="noopener">MySQL Yum Repository</a> ，这里我们选择 <strong>Red Hat Enterprise Linux 8 / Oracle Linux 8 (Architecture Independent), RPM Package</strong> 版本</p>
<blockquote>
<p>这里只是作为演示，根据自己的需求挑选不同版本的包</p>
</blockquote>
<h3 id="安装YUM仓库"><a href="#安装YUM仓库" class="headerlink" title="安装YUM仓库"></a>安装YUM仓库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载到当前目录下</span></span><br><span class="line">wget https://repo.mysql.com//mysql80-community-release-el8-1.noarch.rpm</span><br><span class="line"><span class="comment"># 使用 yum 本地安装</span></span><br><span class="line">yum localinstall mysql80-community-release-el8-1.noarch.rpm</span><br><span class="line"><span class="comment"># 查看包源是否安装成功</span></span><br><span class="line">yum repolist enabled | grep <span class="string">"mysql.*-community.*"</span></span><br><span class="line"><span class="comment"># 输出内容如下</span></span><br><span class="line">mysql-connectors-community           MySQL Connectors Community              42</span><br><span class="line">mysql-tools-community                MySQL Tools Community                   19</span><br><span class="line">mysql80-community                    MySQL 8.0 Community Server              31</span><br></pre></td></tr></table></figure>

<h3 id="配置MySQL服务"><a href="#配置MySQL服务" class="headerlink" title="配置MySQL服务"></a>配置MySQL服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装MySQL服务</span></span><br><span class="line">yum install mysql-server</span><br><span class="line"><span class="comment"># 启动MySQL服务</span></span><br><span class="line">systemctl start mysqld</span><br><span class="line"><span class="comment"># 查看MySQL服务状态</span></span><br><span class="line">systemctl status mysqld</span><br><span class="line"><span class="comment"># 输出如下则表示开启</span></span><br><span class="line">● mysqld.service - MySQL 8.0 database server</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/mysqld.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Tue 2020-04-21 16:22:47 CST; 10s ago</span><br><span class="line">  Process: 11914 ExecStartPost=/usr/libexec/mysql-check-upgrade (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 11787 ExecStartPre=/usr/libexec/mysql-prepare-db-dir mysqld.service (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 11763 ExecStartPre=/usr/libexec/mysql-check-socket (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 11871 (mysqld)</span><br><span class="line">   Status: <span class="string">"Server is operational"</span></span><br><span class="line">    Tasks: 39 (<span class="built_in">limit</span>: 4888)</span><br><span class="line">   Memory: 328.3M</span><br><span class="line">   CGroup: /system.slice/mysqld.service</span><br><span class="line">           └─11871 /usr/libexec/mysqld --basedir=/usr</span><br></pre></td></tr></table></figure>

<h3 id="配置MySQL数据库"><a href="#配置MySQL数据库" class="headerlink" title="配置MySQL数据库"></a>配置MySQL数据库</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看MySQL服务日志与password相关的内容</span></span><br><span class="line">grep <span class="string">'password'</span> /var/<span class="built_in">log</span>/mysql/mysqld.log</span><br><span class="line"><span class="comment"># 演示时输出如下</span></span><br><span class="line">2020-04-21T08:22:41.675426Z 5 [Warning] [MY-010453] [Server] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.</span><br><span class="line"><span class="comment"># 这里提示我们Server为root@localhost账号创建了个空的密码,我们这里直接登入MySQL</span></span><br><span class="line">mysql -u root -p</span><br><span class="line">Enter password: </span><br><span class="line"><span class="comment"># 直接回车，输出如下及登入成功</span></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.17 Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line"><span class="comment"># 修改root@localhost的密码(这里演示修改密码为：qwe123)</span></span><br><span class="line">mysql&gt; ALTER USER <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED WITH mysql_native_password BY <span class="string">'qwe123'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.08 sec)</span><br><span class="line"><span class="comment"># 为外网访问添加账户(%代表所有地址都可能访问,使用时根据实际情况)</span></span><br><span class="line">CREATE USER <span class="string">'unshell'</span>@<span class="string">'%'</span> IDENTIFIED BY <span class="string">'qwe123'</span>;</span><br><span class="line"><span class="comment"># 授予权限(这里演示提供所有权限,使用时根据实际情况)</span></span><br><span class="line">GRANT ALL ON *.* TO <span class="string">'unshell'</span>@<span class="string">'%'</span> WITH GRANT OPTION;</span><br></pre></td></tr></table></figure>

<h3 id="开启防火墙对应端口"><a href="#开启防火墙对应端口" class="headerlink" title="开启防火墙对应端口"></a>开启防火墙对应端口</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启防火墙</span></span><br><span class="line">systemctl start firewalld</span><br><span class="line"><span class="comment"># 开放默认3306端口</span></span><br><span class="line">firewall-cmd --add-port=3306/tcp --permanent</span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你使用的连接工具是Navicat，可能会存在密码加密方式不支持的问题，像root@localhost账户那样修改加密方式为 mysql_native_password 即可</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/04/21/CentOs%E5%AE%89%E8%A3%85MySql/" data-id="ckaq4osl00001cksmcwff1b7f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-快速使用MySQL" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/03/03/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8MySQL/" class="article-date">
  <time datetime="2020-03-03T00:36:43.000Z" itemprop="datePublished">2020-03-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/03/03/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8MySQL/">快速使用 MySQL</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>操作系统：Windows 10 | MySQL 版本 8.0.16 | 博客记录时间：2020/3/1 16:05</p>
<h3 id="安装-MySQL-Community-Server"><a href="#安装-MySQL-Community-Server" class="headerlink" title="安装 MySQL Community Server"></a>安装 MySQL Community Server</h3><p>进入 MySQL官网 <a href="https://dev.mysql.com/downloads/mysql/" target="_blank" rel="noopener">下载</a> ZIP Archive：</p>
<p><img src="/blog/css/images/article/mysql/fast-use-mysql01.png" alt="fast-use-mysql01"></p>
<p>点击下载后进入到下个页面，选择 No thanks, just start my download：</p>
<p><img src="/blog/css/images/article/mysql/fast-use-mysql02.png" alt="fast-use-mysql02"></p>
<p>下载完之后进行解压，这里我们把压缩包解压在 F:\mysql</p>
<p>以 <strong>管理员的身份</strong> 打开 cmd 命令行工具，切换目录并输入 mysql 如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> <span class="built_in">cd</span> F:\mysql\bin</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql</span></span><br><span class="line">// 如果输出如下，就可以开始装载服务了</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ERROR 2003 (HY000): Can<span class="string">'t connect to MySQL server on '</span>localhost<span class="string">' (10061)</span></span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>如果你的系统特别干净，可能会跳出提示框提示你缺少dll文件，只要把 <a href="/blog/css/images/article/mysql/msvcp140.dll">msvcp140.dll</a> 和 <a href="/blog/css/images/article/mysql/vcruntime140.dll">vcruntime140.dll</a> 放在 系统盘的Windows\System32 文件夹下再输入 mysql 就可以了。</p>
</blockquote>
<h3 id="配置-MySQL-服务"><a href="#配置-MySQL-服务" class="headerlink" title="配置 MySQL 服务"></a>配置 MySQL 服务</h3><p>在配置 MySQL 服务之前，我们先配置下 MySQL 的配置文件，创建名为 <strong>my.ini</strong> 的文件在 F:\mysql\ 目录下，配置内容如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="comment"># 设置mysql客户端默认字符集</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="comment"># 设置3306端口</span></span><br><span class="line"><span class="attr">port</span> = <span class="number">3306</span></span><br><span class="line"><span class="comment"># 设置mysql的安装目录</span></span><br><span class="line"><span class="attr">basedir</span>=F:\\mysql</span><br><span class="line"><span class="comment"># 设置 mysql数据库的数据的存放目录，MySQL 8+ 不需要以下配置，系统自己生成即可，否则有可能报错</span></span><br><span class="line"><span class="comment"># datadir=F:\\sqldata</span></span><br><span class="line"><span class="comment"># 允许最大连接数</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="number">100</span></span><br><span class="line"><span class="comment"># 服务端使用的字符集默认为8比特编码的latin1字符集</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8mb4</span><br><span class="line"><span class="comment"># 创建新表时将使用的默认存储引擎</span></span><br><span class="line"><span class="attr">default-storage-engine</span>=INNODB</span><br></pre></td></tr></table></figure>

<p>之后我们再使用 cmd 命令行工具初始化数据库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysqld --initialize --console</span></span><br></pre></td></tr></table></figure>

<ul>
<li>–initialize : 初始化</li>
<li>–console : 输出在控制台</li>
</ul>
<p>执行完成后，会输出 root 用户的初始化密码，如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> ....</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> [Note] [MY-010454] [Server] A temporary password is generated <span class="keyword">for</span> root@localhost: g)tqN+Oia4_a</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> ....</span></span><br></pre></td></tr></table></figure>

<p><strong>g)tqN+Oia4_a</strong> 就是初始化密码，之后登入会用到：</p>
<p>输入以下安装命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysqld install</span></span><br></pre></td></tr></table></figure>

<p>之后启动服务：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> net start mysql</span></span><br></pre></td></tr></table></figure>

<h3 id="登入MySQL"><a href="#登入MySQL" class="headerlink" title="登入MySQL"></a>登入MySQL</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql -h 主机名 -u 用户名 -p</span></span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<ul>
<li>-h：指定客户端要登录的 MySQL 主机名，登录本机（localhost 或 127.0.0.1）该参数可以省略；</li>
<li>-u：登录的用户名；</li>
<li>-p：告诉服务器将会使用一个密码来登录，如果所要登录的用户名密码为空, 可以忽略此选项。</li>
</ul>
<p>登入实例如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> mysql -u root -p</span></span><br></pre></td></tr></table></figure>

<p>按 Enter 键后确认，如果MySQL正在运行则会得到如下响应：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Enter password:</span><br></pre></td></tr></table></figure>

<p>输入刚才的密码：<strong>g)tqN+Oia4_a</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 8.0.16 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2019, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"><span class="meta">mysql&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果输出为以上的内容说明已经可以登录 MySQL 了。</p>
<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>值得一提的是MySQL 8和低版本的MySQL修改密码的方式有差别，而且密码的编码方式也有区别</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;qwe123&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.34 sec)</span><br></pre></td></tr></table></figure>

<p>如果你使用数据库连接工具，如 <strong>Navicat Premium</strong> 连接的时候可能在当前版本得修改密码编码方式，否者会提示：</p>
<blockquote>
<p>[ERROR 2059] - Authentication plugin ‘caching_sha2_password’ cannot be loaded…</p>
</blockquote>
<p>修改密码编码方式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY &#39;qwe123&#39;;</span><br><span class="line">Query OK, 0 rows affected (0.12 sec)</span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line">mysql&gt; SELECT HOST,USER,PLUGIN FROM MYSQL.USER;</span><br><span class="line">+-----------+------------------+-----------------------+</span><br><span class="line">| HOST      | USER             | PLUGIN                |</span><br><span class="line">+-----------+------------------+-----------------------+</span><br><span class="line">| localhost | mysql.infoschema | caching_sha2_password |</span><br><span class="line">| localhost | mysql.session    | caching_sha2_password |</span><br><span class="line">| localhost | mysql.sys        | caching_sha2_password |</span><br><span class="line">| localhost | root             | mysql_native_password |</span><br><span class="line">+-----------+------------------+-----------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>可以看到用户为 root 的 PLUGIN 已经改成了 mysql_native_password。</p>
<p>到这里就一切准备就绪了！</p>
<h2 id="删除-MySQL-Community-Server"><a href="#删除-MySQL-Community-Server" class="headerlink" title="删除 MySQL Community Server"></a>删除 MySQL Community Server</h2><h3 id="停止服务"><a href="#停止服务" class="headerlink" title="停止服务"></a>停止服务</h3><p>使用管理员身份打开 CMD ，输入net stop mysql：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> net stop mysql</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> MySQL 服务正在停止...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> MySQL 服务已成功停止。</span></span><br><span class="line">// 如果不是管理员身份可能发生下面的情况</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 发生系统错误 5。</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> 拒接访问。</span></span><br></pre></td></tr></table></figure>

<h3 id="删除-Windows-注册表"><a href="#删除-Windows-注册表" class="headerlink" title="删除 Windows 注册表"></a>删除 Windows 注册表</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> sc delete mysql</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> [SC] DeleteService 成功</span></span><br></pre></td></tr></table></figure>

<h3 id="删除环境变量"><a href="#删除环境变量" class="headerlink" title="删除环境变量"></a>删除环境变量</h3><p>如果之前有配置环境变量的话，将Path里关于MySQL的环境变量删除即可</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/03/03/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8MySQL/" data-id="ckaq4oslb000ccksm1k8j3ml4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/fast/" rel="tag">fast</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/mysql/" rel="tag">mysql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Tomcat常用配置项" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/01/04/Tomcat%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/" class="article-date">
  <time datetime="2020-01-04T10:52:53.000Z" itemprop="datePublished">2020-01-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/01/04/Tomcat%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/">Tomcat 常用配置项</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="运行环境"><a href="#运行环境" class="headerlink" title="运行环境"></a>运行环境</h3><ul>
<li>基础Java运行环境（JDK 1.8）</li>
<li>Windows<h3 id="修改端口号"><a href="#修改端口号" class="headerlink" title="修改端口号"></a>修改端口号</h3>conf &gt; server.xml<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">"Catalina"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8080"</span> <span class="attr">protocol</span>=<span class="string">"HTTP/1.1"</span> <span class="attr">connectionTimeout</span>=<span class="string">"20000"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">"8009"</span> <span class="attr">protocol</span>=<span class="string">"AJP/1.3"</span> <span class="attr">redirectPort</span>=<span class="string">"8443"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>port ：端口号</li>
<li>protocol ：服务协议（HTTP / AJP）</li>
<li>connectionTimeout ：连接超时（毫秒）</li>
<li>redirectPort ：端口重定向</li>
</ul>
<blockquote>
<p>当一个用户用HTTP请求某个资源时，该资源本身又被设置需要HTTPS方式访问，此时Tomcat会自动重定向到这个redirectPort设置的HTTPS端口</p>
</blockquote>
<p>注意：端口范围 1 ~ 65535</p>
<h3 id="内存模型"><a href="#内存模型" class="headerlink" title="内存模型"></a>内存模型</h3><table>
<thead>
<tr>
<th>内存</th>
<th>内容</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>堆内存</td>
<td>类、数组、实例化的对象</td>
<td>最小为物理内存的1/64，最大为物理内存的1/4</td>
</tr>
<tr>
<td>栈内存</td>
<td>局部变量</td>
<td></td>
</tr>
<tr>
<td>静态内存区</td>
<td>常量、静态变量、meta数据（属性、方法）</td>
<td>默认21m，最大值无上限</td>
</tr>
</tbody></table>
<blockquote>
<p>修改内存配置，应对内存溢出异常（OutofMemoryError）</p>
</blockquote>
<h6 id="内存异常"><a href="#内存异常" class="headerlink" title="内存异常"></a>内存异常</h6><ul>
<li>Java heap space 异常</li>
<li>PermGen space 异常（JDK 8 以下）</li>
<li>StackOverflowError 异常<h6 id="内存配置"><a href="#内存配置" class="headerlink" title="内存配置"></a>内存配置</h6>bin &gt;  catalina.bat<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">// 方法一 ：直接在第二行加下一行</span><br><span class="line">JAVA_OPTS=<span class="string">"-server -Xms256m -Xmx512m -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=256m"</span></span><br><span class="line"></span><br><span class="line">&lt;!-- 下面也有地方设置 --&gt;</span><br><span class="line"><span class="keyword">if</span> not <span class="string">"%JSSE_OPTS%"</span> == <span class="string">""</span> goto gotJsseOpts</span><br><span class="line"><span class="built_in">set</span> JSSE_OPTS=<span class="string">"-Djdk.tls.ephemeralDHKeySize=2048"</span></span><br><span class="line">:gotJsseOpts</span><br><span class="line">// 方法二</span><br><span class="line"><span class="built_in">set</span> <span class="string">"JAVA_OPTS=%JAVA_OPTS% %JSSE_OPTS%"</span></span><br></pre></td></tr></table></figure></li>
<li>Xms : Java Heap Initial Size <code>堆初始化大小</code></li>
<li>Xmx : Java Heap Max <code>堆最大值</code></li>
<li>MetaspaceSize : Initial Meta Space Size <code>元空间初始大小</code></li>
<li>MaxMetaspaceSize : Meta Space Max <code>元空间最大值</code></li>
</ul>
<blockquote>
<p>Java 虚拟机(JVM) 的堆大小决定垃圾回收的频率</p>
</blockquote>
<h3 id="热部署"><a href="#热部署" class="headerlink" title="热部署"></a>热部署</h3><h6 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h6><p>conf &gt; server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Service</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Engine</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Host</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Context</span> <span class="attr">debug</span>=<span class="string">"0"</span> <span class="attr">docBase</span>=<span class="string">"E:\test\web"</span> <span class="attr">path</span>=<span class="string">"/test"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>debug : 关联日志信息，值越大内容越详细</li>
<li>docBase : 项目的绝对路径或相对路径（相对于webapps）</li>
<li>path : 项目后的字符串</li>
<li>reloadable<h6 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h6>conf &gt; Catalina &gt; localhost<br>新建一个<code>xml</code>文件，名称就是方法一的<code>path</code>字段</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">"E:\test\web"</span> <span class="attr">reloadable</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Web管理界面"><a href="#Web管理界面" class="headerlink" title="Web管理界面"></a>Web管理界面</h3><p><img src="/blog/css/images/article/tomcat/01.png" alt="Tomcat 管理界面"><br>这里作为示例，点击 Manager App  ，登入（之前账号和密码需要配置）<br><img src="/blog/css/images/article/tomcat/02.png" alt="Web 管理界面"></p>
<h6 id="密码配置"><a href="#密码配置" class="headerlink" title="密码配置"></a>密码配置</h6><p>conf &gt; tomcat-users.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">  &lt;role rolename="tomcat"/&gt;</span></span><br><span class="line"><span class="comment">  &lt;role rolename="role1"/&gt;</span></span><br><span class="line"><span class="comment">  &lt;user username="tomcat" password="&lt;must-be-changed&gt;" roles="tomcat"/&gt;</span></span><br><span class="line"><span class="comment">  &lt;user username="both" password="&lt;must-be-changed&gt;" roles="tomcat,role1"/&gt;</span></span><br><span class="line"><span class="comment">  &lt;user username="role1" password="&lt;must-be-changed&gt;" roles="role1"/&gt;</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">role</span> <span class="attr">rolename</span>=<span class="string">"manager-gui"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">username</span>=<span class="string">"tomcat"</span> <span class="attr">password</span>=<span class="string">"123456"</span> <span class="attr">roles</span>=<span class="string">"manager-gui"</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<p>注释为示例，是对账号管理和认证授权的配置<br>这里我们配置角色<code>manager-gui</code>，账号：tomcat 密码：123456</p>
<h3 id="Tomcat-安全相关配置"><a href="#Tomcat-安全相关配置" class="headerlink" title="Tomcat 安全相关配置"></a>Tomcat 安全相关配置</h3><h6 id="关闭服务器端口"><a href="#关闭服务器端口" class="headerlink" title="关闭服务器端口"></a>关闭服务器端口</h6><p>conf &gt; server.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Server</span> <span class="attr">port</span>=<span class="string">"8005"</span> <span class="attr">shutdown</span>=<span class="string">"QUT"</span>&gt;</span><span class="tag">&lt;/<span class="name">Server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里关闭端口为<code>8005</code>，命令这里为<code>QUT</code>（修改默认）</p>
<h6 id="修改版本号"><a href="#修改版本号" class="headerlink" title="修改版本号"></a>修改版本号</h6><p>lib &gt; catalina.jar &gt; org &gt; apache &gt; catalina &gt; util &gt; ServerInfo.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">//</span> <span class="string">修改 info</span></span><br><span class="line"><span class="meta">server.info</span>=<span class="string">Apache Tomcat / 7.0.82</span></span><br><span class="line"><span class="meta">server.number</span>=<span class="string">7.0.82.0</span></span><br><span class="line"><span class="meta">server.built</span>=<span class="string">Sep 29 2017 12:23:15 UTC</span></span><br></pre></td></tr></table></figure>
<h6 id="禁用管理界面"><a href="#禁用管理界面" class="headerlink" title="禁用管理界面"></a>禁用管理界面</h6><p>管理界面定向文件为 webapp &gt; ROOT 文件夹，所以重命名ROOT，新建一个空ROOT。</p>
<h6 id="自定义报错页面"><a href="#自定义报错页面" class="headerlink" title="自定义报错页面"></a>自定义报错页面</h6><p>conf &gt; web.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 在 web-app 下 添加 error-page --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/error-404.html<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>如需配置其他状态，格式一样</code></p>
<h6 id="HttpOnly"><a href="#HttpOnly" class="headerlink" title="HttpOnly"></a>HttpOnly</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version='1.0' encoding='utf-8'?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 开启 HttpOnly --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">useHttpOnly</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/01/04/Tomcat%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E9%A1%B9/" data-id="ckaq4osl50005cksm46cz5tre" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/tomcat/" rel="tag">tomcat</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-CodeFrist" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/blog/2020/01/04/CodeFrist/" class="article-date">
  <time datetime="2020-01-04T10:46:51.000Z" itemprop="datePublished">2020-01-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/blog/2020/01/04/CodeFrist/">Entity Framework - Code Frist</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在关系数据库中，不同表之间往往不是全部都单独存在，而是相互存在关联的。两个不同表之间可以存在外键依赖关系，一个表自身也可以有自反关系(表中的一个字段引用主键，从而也是外键字段)。</p>
<h3 id="外键列名默认约定"><a href="#外键列名默认约定" class="headerlink" title="外键列名默认约定"></a>外键列名默认约定</h3><p><strong>一对多关系：</strong>以产品类<code>Product</code>和类别类<code>Gategory</code>为例，一个类别对应多个产品。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 产品类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 产品编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> ProductID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 产品名称</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> ProductName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 产品价格</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">decimal</span>? UnitPrice &#123; <span class="keyword">get</span>; <span class="keyword">set</span>;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 产品数量</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? Quantity &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分类编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> CategoryID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 分类属性-关系</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Category Category &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到<code>Product 类</code>中定义了<code>Category 类</code>作为主键属性。</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 类别类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Category</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类别编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> CategoryID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 类别名称</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> CategoryName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 产品集</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ICollection&lt;Product&gt; Products &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同样的，<code>Category 类</code>中也定义了<code>Product 类</code>的集合属性。</p>
</blockquote>
<p>说明：在<code>Category 类</code>及<code>Product 类</code>中的引用属性及集合属性前加<code>virtual</code>修饰，为的是<code>Entity Framework Code First</code>的延迟加载功能。不使用<code>virtual</code>修饰，在<code>Category 类</code>的一个实例要查询包含的<code>Product</code>实例时，将不会启用延迟加载。当然<code>Entity Framework Code First</code>延迟加载并不是必须的，所以<code>virtual</code>修饰符也可以不加。<br>　　在定义以上两个类之后，不再添加任何的Entity Framework Code First与数据库的映射配置，运行之后，生成的数据表结构为：<br><img src="/blog/css/images/article/codefirst/01.png" alt="数据表结构"><br>　　从生成的<code>Categories</code>与<code>Products</code>表结构可以看出，在<code>Products</code>表中的外键<code>CategoryID</code>与引用的表<code>Categories</code>主键名称相同。<br>在数据库中生成的Products表，查看外键<code>FK_dbo.Products_dbo.Categories_CategoryID</code>属性，其的确有启用级联删除功能。<br><img src="/blog/css/images/article/codefirst/02.png" alt="外键关系-级联"></p>
<blockquote>
<p>级联：当删除Categories表中一条记录时，数据库会自动联带删除<code>Products</code>表中属于该类别的记录。</p>
</blockquote>
<p>除了这种方式以外还有<code>Data Annotations</code>和<code>Fluent API</code>两种方式实现。<br>还是以<code>Product类</code>和<code>Category类</code>为例子：</p>
<ol>
<li><strong>Data Annotations 配置外键</strong><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> CatID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">[<span class="meta">ForeignKey(<span class="meta-string">"CatID"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> Category Category &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
或者<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">ForeignKey(<span class="meta-string">"Category"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> CatID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">virtual</span> Category Category &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>
这里的<code>CatID</code>为<code>CategoryID</code>的简写用做演示，可更改。<br>需要引用：<code>using System.ComponentModel.DataAnnotations.Schema;</code></li>
<li><strong>Fluent API 配置关系</strong><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">DbModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//禁用所有一对多表中存在的联级关系</span></span><br><span class="line">    <span class="comment">//modelBuilder.Conventions.Remove&lt;OneToManyCascadeDeleteConvention&gt;();</span></span><br><span class="line"></span><br><span class="line">    modelBuilder.Entity&lt;Category&gt;()</span><br><span class="line">        .HasMany(t =&gt; t.Products)</span><br><span class="line">        .WithRequired(t =&gt; t.Category)</span><br><span class="line">        .HasForeignKey(d =&gt; d.CatID);</span><br><span class="line"></span><br><span class="line">    modelBuilder.Entity&lt;Product&gt;()</span><br><span class="line">        .HasRequired(t =&gt; t.Category)</span><br><span class="line">        .WithMany(t =&gt; t.Products)</span><br><span class="line">        .HasForeignKey(d =&gt; d.CatID)</span><br><span class="line">    <span class="comment">//  .WillCascadeOnDelete(false); //禁用联级</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在<code>OnModelCreating</code>中只添加对Product实体类的关系映射配置，好处就是关系配置和实体类分离，使得关系清晰。<br>注：<code>不清楚关系看下面的引文</code></p>
</blockquote>
</li>
</ol>
<p>当然这种分离还可以依靠继承<code>EntityTypeConfiguration</code>来做到。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引用</span></span><br><span class="line"><span class="keyword">using</span> System.Data.Entity.ModelConfiguration;</span><br><span class="line"></span><br><span class="line">public class ProductMap : EntityTypeConfiguration&lt;Product&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ProductMap</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 主键</span></span><br><span class="line">        <span class="keyword">this</span>.HasKey(t =&gt; t.ProductID);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 特性</span></span><br><span class="line">        <span class="keyword">this</span>.Property(t =&gt; t.ProductName)</span><br><span class="line">            .IsRequired()</span><br><span class="line">            .HasMaxLength(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表名</span></span><br><span class="line">        <span class="keyword">this</span>.ToTable(<span class="string">"Product"</span>);</span><br><span class="line">        <span class="keyword">this</span>.Property(t =&gt; t.ProductID).HasColumnName(<span class="string">"ProductID"</span>);</span><br><span class="line">        <span class="keyword">this</span>.Property(t =&gt; t.CategoryID).HasColumnName(<span class="string">"CategoryID"</span>);</span><br><span class="line">        <span class="keyword">this</span>.Property(t =&gt; t.ProductName).HasColumnName(<span class="string">"ProductName"</span>);</span><br><span class="line">        <span class="keyword">this</span>.Property(t =&gt; t.UnitPrice).HasColumnName(<span class="string">"UnitPrice"</span>);</span><br><span class="line">        <span class="keyword">this</span>.Property(t =&gt; t.Quantity).HasColumnName(<span class="string">"Quantity"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一对多关系</span></span><br><span class="line">        <span class="keyword">this</span>.HasRequired(t =&gt; t.Category)</span><br><span class="line">            .WithMany(t =&gt; t.Products)</span><br><span class="line">            .HasForeignKey(d =&gt; d.CategoryID)</span><br><span class="line">            .WillCascadeOnDelete(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如上代码所示：创建一个<code>ProductMap类</code>在里面配置实体类<code>主键</code>、<code>表名</code>、<code>特性</code>和<code>外键关系</code>，之后只要在覆写的<code>OnModelCreating</code>方法中添加就可以了，具体情况如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnModelCreating</span>(<span class="params">DbModelBuilder modelBuilder</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    modelBuilder.Configurations.Add(<span class="keyword">new</span> ProductMap());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然配置特性和主键使用<code>Data Annotations</code>的方式也能做到，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引用</span></span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations.Schema;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 产品编号</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Column(<span class="meta-string">"ProductID"</span>), Key, DatabaseGenerated(DatabaseGeneratedOption.Identity)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">int</span> ProductID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 产品名称</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Column(<span class="meta-string">"ProductName"</span>), Required, MaxLength(100)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">string</span> ProductName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"><span class="comment">//这里只做演示，不完整</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>个人偏向创建<code>Map.cs</code>的方法，会比较清晰好修改。</p>
</blockquote>
<p><strong>一对一关系：</strong>以<code>User 类</code>和<code>UserProfile 类</code>为例，一个用户对应一个用户简介。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用户类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> UserID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> UserName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 密码</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 是否有效</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">bool</span>? IsValid &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户简介</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> UserProfile UserProfile &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到<code>User 类</code>中定义了<code>UserProfile 类</code>作为主键属性。</p>
</blockquote>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 用户信息类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserProfile</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 简介编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> ProfileID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 姓名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 性别</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Nullable&lt;<span class="keyword">bool</span>&gt; Sex &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 出生日期</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> Nullable&lt;DateTime&gt; Birthday &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 邮箱</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Email &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 电话</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Telephone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 手机</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Mobilephone &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 地址</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> Address &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 创建时间</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> DateTime? CreateDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> User User &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>同样的<code>UserProfile 类</code>中定义了<code>User 类</code>作为主键属性。</p>
</blockquote>
<p>在定义以上两个类之后，不再添加任何的Entity Framework Code First与数据库的映射配置，运行之后，生成的数据表结构为：<br><img src="/blog/css/images/article/codefirst/03.png" alt="数据表结构"><br>当然仅为了实现一对一关系的话也可以让<code>UserID</code>做外键，但在真实项目中要明确主外键关系。</p>
<blockquote>
<p>当然通过覆写<code>OnModelCreating</code>方法同样可以做到，这里就不多做演示了。</p>
</blockquote>
<p><strong>多对多关系：</strong>以<code>User 类</code>和<code>Role 类</code>为例，一个用户可能属于多个角色，一个角色可以包含多个用户。<br>添加<code>Role</code>类，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 角色类</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Role</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 角色编号</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> RoleID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 角色名</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> RoleName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 用户集</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ICollection&lt;User&gt; Users &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里<code>User 类</code>和<code>Role 类</code>双方定义对方类的集合属性</p>
</blockquote>
<p>在定义以上两个类之后，不再添加任何的Entity Framework Code First与数据库的映射配置，运行之后，生成的数据表结构为：<br><img src="/blog/css/images/article/codefirst/04.png" alt="数据表结构"></p>
<blockquote>
<p>这里值得注意的是：实体类运行之后，除了生成<code>Users 表</code>和<code>Roles 表</code>之外，还生成了<code>RoleUsers 表</code>作为中介表<code>RoleUsers 表</code>里面包含双方的主键。</p>
</blockquote>
<hr>
<p><strong>一对多自反关系：</strong>以<code>Category 类</code>为例，这种关系大多出现形式为节点<code>Node</code>类，跟文件夹相似。<br>代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Category</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> CategoryID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span> CategoryNo &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">string</span> CategoryName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>? ParentID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> Category Parent &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">virtual</span> ICollection&lt;Category&gt; Children &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>类别表通过一个ParentID列保存引用主键，用来实现无限级递归。</p>
</blockquote>
<h3 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h3><ul>
<li>本文引文：<a href="https://www.cnblogs.com/libingql/p/3353112.html" target="_blank" rel="noopener">Entity Framework Code First关系映射约定</a></li>
<li>推荐文章：<a href="https://www.cnblogs.com/enigmaxp/p/9159391.html" target="_blank" rel="noopener">EntityFrameworkCore2.1的安装使用和其中遇到的那些坑</a></li>
<li>EF实体类配置关系：<a href="https://www.cnblogs.com/Leo_wl/p/3624614.html" target="_blank" rel="noopener">EF实体类配置总结</a></li>
<li>更加详细的文档：<a href="http://www.entityframeworktutorial.net/code-first/dataannotation-in-code-first.aspx" target="_blank" rel="noopener">EntityFramework 文档</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://unshell.github.io/2020/01/04/CodeFrist/" data-id="ckaq4oskv0000cksman905rxj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blog/tags/entity-framework/" rel="tag">entity_framework</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/blog/page/2/">2</a><a class="extend next" rel="next" href="/blog/page/2/">下一页 &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/bug/" rel="tag">bug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/entity-framework/" rel="tag">entity_framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/fast/" rel="tag">fast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/http/" rel="tag">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/other/" rel="tag">other</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/regex/" rel="tag">regex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/blog/tags/tomcat/" rel="tag">tomcat</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/blog/tags/bug/" style="font-size: 10px;">bug</a> <a href="/blog/tags/entity-framework/" style="font-size: 10px;">entity_framework</a> <a href="/blog/tags/fast/" style="font-size: 15px;">fast</a> <a href="/blog/tags/http/" style="font-size: 10px;">http</a> <a href="/blog/tags/linux/" style="font-size: 10px;">linux</a> <a href="/blog/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/blog/tags/other/" style="font-size: 15px;">other</a> <a href="/blog/tags/regex/" style="font-size: 10px;">regex</a> <a href="/blog/tags/tomcat/" style="font-size: 20px;">tomcat</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/05/">五月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/04/">四月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/blog/archives/2020/01/">一月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blog/2020/05/28/%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE%E5%88%B0Tomcat/">发布项目到Tomcat</a>
          </li>
        
          <li>
            <a href="/blog/2020/04/27/%E9%83%A8%E7%BD%B2%E5%A4%96%E7%BD%AETomcat%E9%A1%B9%E7%9B%AE/">部署外置Tomcat项目</a>
          </li>
        
          <li>
            <a href="/blog/2020/04/23/Tomcat%E9%83%A8%E7%BD%B2%E9%A1%B9%E7%9B%AE%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/">Tomcat 部署项目时遇到的问题</a>
          </li>
        
          <li>
            <a href="/blog/2020/04/23/Tomcat%E6%9C%8D%E5%8A%A1/">Tomcat 服务</a>
          </li>
        
          <li>
            <a href="/blog/2020/04/23/%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8Tomcat/">快速使用 Tomcat</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Unshell<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/blog/" class="mobile-nav-link">home</a>
  
    <a href="/blog/archives" class="mobile-nav-link">archives</a>
  
</nav>
    

<script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"></script>


  
<link rel="stylesheet" href="/blog/fancybox/jquery.fancybox.css">

  
<script src="/blog/fancybox/jquery.fancybox.pack.js"></script>




<script src="/blog/js/script.js"></script>




  </div>
</body>
</html>