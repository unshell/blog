<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="阿丘的博客">
    <meta name="keyword" content="">
    <link rel="shortcut icon" href="/blog/image/favicon.svg">

    <title>
        
        Tomcat 服务 - 阿丘的博客 | Unshell&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/blog/css/aircloud.css">
    <!-- Icon CSS -->
    <link rel="stylesheet" href="//at.alicdn.com/t/font_2103599_gii1mr7u70l.css" type="text/css">
</head>
<body>
    <div class="site-nav-toggle" id="site-nav-toggle">
        <button><i class="iconfont icon-menu1"></i></button>
    </div>

    <div class="index-about">
        <i> 我相信所有坚韧不拔的努力，迟早会得来好报酬 </i>
    </div>

    <div class="index-container">
        
        <div class="index-left">
            <div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/blog/image/avatar.jpeg" />
        </div>
        <div class="name">
            <i>阿 丘</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/blog/">
                    <i class="iconfont icon-home-"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/blog/tags">
                    <i class="iconfont icon-tags"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/blog/archive">
                    <i class="iconfont icon-guidang"></i>
                    <span>归档</span>
                </a>
            </li>
            <li >
                <a href="/blog/about/">
                    <i class="iconfont icon-guanyu"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo-2"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
    <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#catalina-bat"><span class="toc-text">catalina.bat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#org-apache-catalina"><span class="toc-text">org.apache.catalina</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Server-中的-shutdown-属性"><span class="toc-text">Server 中的 shutdown 属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#引文"><span class="toc-text">引文</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="iconfont icon-chacha"></i></span>
            <input id="search-input" />
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container"></div>
    </div>
</div>
            <div class="index-about-mobile">
                <i> 我相信所有坚韧不拔的努力，迟早会得来好报酬 </i>
            </div>
        </div>
        
        <div class="index-middle">
            <!-- Main Content -->
            <div class="post-container">
    <div class="post-title">
        Tomcat 服务
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2020-04-23 12:22:00</span></span>
        
        <span class="attr">标签：/
            
            <a class="tag" href="/blog/tags/#tomcat" title="tomcat">tomcat</a>
            <span>/</span>
            
            
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
        </span>
        </span>
    </div>
    <div class="post-content ">
        <h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>运行环境：Windows 10 | Apache Tomcat 9.0.34 | 博客记录时间：2020-4-23 17:16:12</p>
<p>通常我们 打开 / 关闭 Tomcat 服务时都会执行bin目录下的 startup.bat / shutdown.bat 文件。</p>
<p>但是细心的小伙伴就会发现(╮(￣▽￣)╭)，<code>startup.bat</code> 和 <code>shutdown.bat</code> 文件中都有这么一句话。</p>
<pre><code class="bash">rem ---------------------------------------------------------------------------
rem Start / Stop script for the CATALINA Server
rem ---------------------------------------------------------------------------
call &quot;%EXECUTABLE%&quot; start / stop %CMD_LINE_ARGS%
</code></pre>
<p>所以不论是 startup 还是 shutdown 都是执行了 <code>catalina.bat</code>，只是执行的指令不同。</p>
<h3 id="catalina-bat"><a href="#catalina-bat" class="headerlink" title="catalina.bat"></a>catalina.bat</h3><p>首选我们分析下 <code>catalina.bat</code> 脚本的内容：</p>
<pre><code class="bash">rem Guess CATALINA_HOME if not defined
set &quot;CURRENT_DIR=%cd%&quot;
if not &quot;%CATALINA_HOME%&quot; == &quot;&quot; goto gotHome
set &quot;CATALINA_HOME=%CURRENT_DIR%&quot;
if exist &quot;%CATALINA_HOME%\bin\catalina.bat&quot; goto okHome
cd ..
set &quot;CATALINA_HOME=%cd%&quot;
cd &quot;%CURRENT_DIR%&quot;
</code></pre>
<p>检验 CATALINA_HOME 环境变量，如果不正确则重新设置。</p>
<pre><code class="bash">set CLASSPATH=

rem Get standard environment variables
if not exist &quot;%CATALINA_BASE%\bin\setenv.bat&quot; goto checkSetenvHome
call &quot;%CATALINA_BASE%\bin\setenv.bat&quot;
goto setenvDone
:checkSetenvHome
if exist &quot;%CATALINA_HOME%\bin\setenv.bat&quot; call &quot;%CATALINA_HOME%\bin\setenv.bat&quot;
:setenvDone

rem Get standard Java environment variables
if exist &quot;%CATALINA_HOME%\bin\setclasspath.bat&quot; goto okSetclasspath
echo Cannot find &quot;%CATALINA_HOME%\bin\setclasspath.bat&quot;
echo This file is needed to run this program
goto end
:okSetclasspath
call &quot;%CATALINA_HOME%\bin\setclasspath.bat&quot; %1
if errorlevel 1 goto end
</code></pre>
<p>设置环境变量：</p>
<ul>
<li>在 CATALINA_BASE 和 CATALINA_BASE 寻找<code>setenv.bat</code>文件并执行，找不到则不执行。</li>
<li>寻找<code>setclasspath.bat</code>(设置 Java 相关的环境变量)文件并执行，找不到则结束。</li>
</ul>
<pre><code class="bash">rem Add tomcat-juli.jar to classpath
rem tomcat-juli.jar can be over-ridden per instance
if not exist &quot;%CATALINA_BASE%\bin\tomcat-juli.jar&quot; goto juliClasspathHome
set &quot;CLASSPATH=%CLASSPATH%;%CATALINA_BASE%\bin\tomcat-juli.jar&quot;
goto juliClasspathDone
:juliClasspathHome
set &quot;CLASSPATH=%CLASSPATH%;%CATALINA_HOME%\bin\tomcat-juli.jar&quot;
:juliClasspathDone

if not &quot;%JSSE_OPTS%&quot; == &quot;&quot; goto gotJsseOpts
set &quot;JSSE_OPTS=-Djdk.tls.ephemeralDHKeySize=2048&quot;
:gotJsseOpts
set &quot;JAVA_OPTS=%JAVA_OPTS% %JSSE_OPTS%&quot;

rem Register custom URL handlers
rem Do this here so custom URL handles (specifically &#39;war:...&#39;) can be used in the security policy
set &quot;JAVA_OPTS=%JAVA_OPTS% -Djava.protocol.handler.pkgs=org.apache.catalina.webresources&quot;

if not &quot;%LOGGING_CONFIG%&quot; == &quot;&quot; goto noJuliConfig
set LOGGING_CONFIG=-Dnop
if not exist &quot;%CATALINA_BASE%\conf\logging.properties&quot; goto noJuliConfig
set LOGGING_CONFIG=-Djava.util.logging.config.file=&quot;%CATALINA_BASE%\conf\logging.properties&quot;
:noJuliConfig

if not &quot;%LOGGING_MANAGER%&quot; == &quot;&quot; goto noJuliManager
set LOGGING_MANAGER=-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager
:noJuliManager
</code></pre>
<p>tomcat-juli.jar：</p>
<ul>
<li>将 <strong>tomcat-juli.jar</strong> 添加到 classPath 环境变量中。</li>
<li>将日志的配置文件路径添加到 LOGGING_CONFIG 环境变量中。</li>
</ul>
<blockquote>
<p>Apache Tomcat由一个自己的实现了 java.util.logging 多个关键元素的实现。这个实现被称为 JULI 。实现的核心组件是定制化的 LogManager ，可以获取运行在Tomcat中的不同web应用(以及不同的class loader)。他支持为应用配置单独的日志配置。当有web应用从内在中是被卸载时，会接到Tomcat的通知，以便他所引用的类可以被清除，避免内存泄露。</p>
</blockquote>
<pre><code class="bash">rem Execute The Requested Command
echo Using CATALINA_BASE:   &quot;%CATALINA_BASE%&quot;
echo Using CATALINA_HOME:   &quot;%CATALINA_HOME%&quot;
echo Using CATALINA_TMPDIR: &quot;%CATALINA_TMPDIR%&quot;
if &quot;&quot;%1&quot;&quot; == &quot;&quot;debug&quot;&quot; goto use_jdk
echo Using JRE_HOME:        &quot;%JRE_HOME%&quot;
goto java_dir_displayed
:use_jdk
echo Using JAVA_HOME:       &quot;%JAVA_HOME%&quot;
:java_dir_displayed
echo Using CLASSPATH:       &quot;%CLASSPATH%&quot;

set _EXECJAVA=%_RUNJAVA%
set MAINCLASS=org.apache.catalina.startup.Bootstrap
set ACTION=start
set SECURITY_POLICY_FILE=
set DEBUG_OPTS=
set JPDA=

if not &quot;&quot;%1&quot;&quot; == &quot;&quot;jpda&quot;&quot; goto noJpda
set JPDA=jpda
if not &quot;%JPDA_TRANSPORT%&quot; == &quot;&quot; goto gotJpdaTransport
set JPDA_TRANSPORT=dt_socket
:gotJpdaTransport
if not &quot;%JPDA_ADDRESS%&quot; == &quot;&quot; goto gotJpdaAddress
set JPDA_ADDRESS=localhost:8000
:gotJpdaAddress
if not &quot;%JPDA_SUSPEND%&quot; == &quot;&quot; goto gotJpdaSuspend
set JPDA_SUSPEND=n
:gotJpdaSuspend
if not &quot;%JPDA_OPTS%&quot; == &quot;&quot; goto gotJpdaOpts
set JPDA_OPTS=-agentlib:jdwp=transport=%JPDA_TRANSPORT%,address=%JPDA_ADDRESS%,server=y,suspend=%JPDA_SUSPEND%
:gotJpdaOpts
shift
:noJpda
</code></pre>
<ul>
<li>设置启动类 - org.apache.catalina.startup.Bootstrap</li>
<li>设置远程调试相关参数 - JPDA</li>
</ul>
<pre><code class="bash">if &quot;&quot;%1&quot;&quot; == &quot;&quot;debug&quot;&quot; goto doDebug
if &quot;&quot;%1&quot;&quot; == &quot;&quot;run&quot;&quot; goto doRun
if &quot;&quot;%1&quot;&quot; == &quot;&quot;start&quot;&quot; goto doStart
if &quot;&quot;%1&quot;&quot; == &quot;&quot;stop&quot;&quot; goto doStop
if &quot;&quot;%1&quot;&quot; == &quot;&quot;configtest&quot;&quot; goto doConfigTest
if &quot;&quot;%1&quot;&quot; == &quot;&quot;version&quot;&quot; goto doVersion

echo Usage:  catalina ( commands ... )
echo commands:
echo   debug             Start Catalina in a debugger
echo   debug -security   Debug Catalina with a security manager
echo   jpda start        Start Catalina under JPDA debugger
echo   run               Start Catalina in the current window
echo   run -security     Start in the current window with security manager
echo   start             Start Catalina in a separate window
echo   start -security   Start in a separate window with security manager
echo   stop              Stop Catalina
echo   configtest        Run a basic syntax check on server.xml
echo   version           What version of tomcat are you running?
goto end
</code></pre>
<p>这里值得注意的且常用的(start / stop)，正如开头提到的。</p>
<h3 id="org-apache-catalina"><a href="#org-apache-catalina" class="headerlink" title="org.apache.catalina"></a>org.apache.catalina</h3><p>解压 bin 目录中的 catalina.jar 后我们能找到 org.apache.catalina.startup.Bootstrap 也就是 catalina.bat 里设置的启动类(MAINCLASS)</p>
<pre><code class="java">package org.apache.catalina.startup;
public final class Bootstrap {
    public static void main(String[] args) {
        // --- 略 ---
        String command = &quot;start&quot;;
        if (args.length &gt; 0) {
            command = args[args.length - 1];
        }
        if (command.equals(&quot;start&quot;)) {
            daemon.setAwait(true);
            daemon.load(args);
            daemon.start();
            if (null == daemon.getServer()) {
                System.exit(1);
            } else if (command.equals(&quot;stop&quot;)) {
                daemon.stopServer(args);
            }
        }
        // --- 略 ---
    }
}
</code></pre>
<p>当指令等于<code>start</code>时运行 Catalina.class 中的 <code>start()</code>方法：</p>
<pre><code class="java">package org.apache.catalina.startup;

public class Catalina {
    public void start() {
        // --- 略 ---
        if (this.await) {
            this.await();
            this.stop();
        }
    }
}
</code></pre>
<p>在<code>start()</code>方法中调用了<code>await()</code>和<code>stop()</code>两个方法：</p>
<ul>
<li><p><code>await()</code> 方法监听停止服务请求的方法</p>
</li>
<li><p><code>stop()</code> 方法是停止服务的方法</p>
</li>
</ul>
<blockquote>
<p><code>await()</code> 方法是阻塞方法，只有客户端请求关闭Tomcat服务时，他才会执行<code>stop()</code>方法，否则一直等待关闭请求。</p>
</blockquote>
<p>StandardServer.class 中的 <code>await()</code> 方法：</p>
<pre><code class="java">package org.apache.catalina.core;

public final class StandardServer extends LifecycleMBeanBase implements Server {
    private volatile ServerSocket awaitSocket = null;
    private String shutdown = &quot;SHUTDOWN&quot;;

    public void await() {
        /* 略 */
        try {
            this.awaitSocket = new ServerSocket(this.getPortWithOffset(), 1,InetAddress.getByName(this.address));
        } catch (IOException var67) {
            log.error(sm.getString(&quot;standardServer.awaitSocket.fail&quot;, new Object[]{this.address,String.valueOf(this.getPortWithOffset()), String.valueOf(this.getPort()),String.valueOf(this.getPortOffset())}), var67);
            return;
        }
        ServerSocket serverSocket;
        try {
            /* 略 */
             while(true) {
                 label611: {
                     label610: {
                         try {
                             label634: {
                                 try {
                                     // 执行accept等待请求
                                     socket = serverSocket.accept();
                                     socket.setSoTimeout(10000);
                                     stream = socket.getInputStream();
                                 } catch (SocketTimeoutException var69) {
                                     log.warn(sm.getString(&quot;standardServer.accept.timeout&quot;, new Object[]{System.currentTimeMillis() - acceptStartTime}), var69);
                                     continue;
                                 }
                                 /* 略 */
                             }
                         }
                     }
                 }
                 /* 略 */
                 boolean match = command.toString().equals(this.shutdown);
                 // 如果请求内容与 shutdown 字段相同则跳出循环，Socket 服务停止
                 if (match) {
                     log.info(sm.getString(&quot;standardServer.shutdownViaPort&quot;));
                     var32 = false;
                     break;
                 }
                 log.warn(sm.getString(&quot;standardServer.invalidShutdownCommand&quot;, new Object[]{command.toString()}));
             }
        }
        /* 略 */
    }
}
</code></pre>
<p>可以看到这里开启了一个 ServerSocket ，调用 accept() 方法监听请求。</p>
<p><code>serverSocket.close()</code>之后 <code>start()</code>方法中的<code>this.stop()</code>执行，Server 被关闭。</p>
<p>当指令等于<code>stop</code>时运行 Catalina.class 中的 <code>stopServer()</code>方法：</p>
<pre><code class="java">public void stopServer(String[] arguments) {
    if (arguments != null) {
        this.arguments(arguments);
    }
    Server s = this.getServer();
    if (s == null) {
        /* 略 */
    } else {
        try {
            s.stop();
            s.destroy();
        } catch (LifecycleException var63) {
            log.error(sm.getString(&quot;catalina.stopError&quot;), var63);
        }
    }
}
</code></pre>
<p>显而易见，Server 不为 null 时，停止并且销毁。</p>
<h3 id="Server-中的-shutdown-属性"><a href="#Server-中的-shutdown-属性" class="headerlink" title="Server 中的 shutdown 属性"></a>Server 中的 shutdown 属性</h3><pre><code class="bash">&lt;Server port=&quot;8085&quot; shutdown=&quot;SHUTDOWN&quot;&gt;
</code></pre>
<p>这里<code>shutdown</code>的默认属性就是<code>SHUTDOWN</code>，与 StandardServer 类中 shutdown 属性的值一样。</p>
<blockquote>
<p>当然 StandardServer 类中 shutdown 属性提供了 setShutdown(String shutdown) 方法。</p>
</blockquote>
<p>做个测试，我们执行 startup.bat 先启动 Tomcat ，跳出窗口并打印日志：</p>
<pre><code class="bash">┌────────────────────────────────────────────────────────┐
│Tomcat
├────────────────────────────────────────────────────────┤
│Server.服务器版本:Apache Tomcat/9.0.34
│服务器构建:Apr 3 2020 2020 12:02:52 UTC
│服务器版本号(:9.0.34.0
│# 略
│Server startup in [673] milliseconds
└────────────────────────────────────────────────────────┘
</code></pre>
<p>我们再启动另一个窗口，进入<code>telnet</code>：</p>
<pre><code>┌────────────────────────────────────────────────────────┐
│Command Prompt
├────────────────────────────────────────────────────────┤
│Microsoft Windows [版本 10.0.17763.1039]
│(c) 2018 Microsoft Corporation。保留所有权利。
│C:\Users\Administrator&gt;telnet localhost 8005
│正在连接localhost...
└────────────────────────────────────────────────────────┘
</code></pre><p>之后我们再像8005端口发送点东西</p>
<pre><code>┌────────────────────────────────────────────────────────┐
│Telnet localhost
├────────────────────────────────────────────────────────┤
│unshell
└────────────────────────────────────────────────────────┘
</code></pre><p>发送<code>unshell</code>字符串，Tomcat窗口打印出新的内容</p>
<pre><code>┌────────────────────────────────────────────────────────┐
│Tomcat
├────────────────────────────────────────────────────────┤
│Server.服务器版本:Apache Tomcat/9.0.34
│服务器构建:Apr 3 2020 2020 12:02:52 UTC
│服务器版本号(:9.0.34.0
│# 略
│Server startup in [673] milliseconds
│Invalid shutdown command [unshell] received
└────────────────────────────────────────────────────────┘
</code></pre><p>如果内容没有更新可以尝试按<code>enter</code>键</p>
<pre><code class="verilog"># 完整内容如下(可以看到警告的方法，就如我们之前所说的那样)
23-Apr-2020 16:57:20.166 警告 [main] org.apache.catalina.core.StandardServer.await Invalid shutdown command [unshell] received
</code></pre>
<p>所以当我们输入指令为<code>SHUTDOWN</code>时，Tomcat 就关闭了。</p>
<p>当然这个指令默认监听<code>localhost</code>的关闭请求，如果要支持远程关闭的话，可以添加参数 address，例子如下：</p>
<pre><code class="bash">&lt;Server port=&quot;8085&quot; shutdown=&quot;SHUTDOWN&quot; address=&quot;36.152.44.95&quot;&gt;
</code></pre>
<p>具体版本是否支持该参数，运行 Tomcat ，文档在 <code>http://localhost:8080/docs/config/server.html</code>中有说明。</p>
<p>这里以版本9为例</p>
<p>All implementations of <strong>Server</strong> support the following attributes：</p>
<table>
<thead>
<tr>
<th>Attribute</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>port</td>
<td>The TCP/IP port number on which this server waits for a shutdown command. Set to <code>-1</code> to disable the shutdown port.</td>
</tr>
<tr>
<td>shutdown</td>
<td>The command string that must be received via a TCP/IP connection to the specified port number, in order to shut down Tomcat.</td>
</tr>
<tr>
<td>address</td>
<td>The TCP/IP address on which this server waits for a shutdown command. If no address is specified, <code>localhost</code> is used.</td>
</tr>
</tbody>
</table>
<blockquote>
<p>以上就是所有内容，本文只是在理解 Tomcat 时，碰巧看到的一些边缘内容，作为记录保存下来。</p>
</blockquote>
<h3 id="引文"><a href="#引文" class="headerlink" title="引文"></a>引文</h3><ul>
<li><p><a href="https://www.jianshu.com/p/b2f63ffa964c" target="_blank" rel="noopener">Tomcat catalina.bat 原理解析</a></p>
</li>
<li><p><a href="https://cloud.tencent.com/developer/article/1129737" target="_blank" rel="noopener">Tomcat 怎么停止服务的?</a></p>
</li>
</ul>

    </div>
</div>
        </div>
    </div>

    <footer class="footer">
    <ul class="list-inline text-center">
        
        <li>
            <a target="_blank" href="https://github.com/unshell">
                <span class="fa-stack fa-lg">
                    <i class="iconfont icon-github"></i>
                </span>
            </a>
        </li>
        
    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="https://hexo.io/zh-cn/">Hexo</a></span>
        <span>/</span>
        
        <span><a href="http://niexiaotao.cn/">AirCloud</a></span>
        <span>/</span>
        
        <span><a href="https://www.iconfont.cn/">Alibaba Icon</a></span>
        <span>/</span>
        
    </p>
    
    <p>@ 2018 - 2020 UnShell</p>
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
    </p>
</footer>
</body>
<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json";
    window.hexo_root = "/blog/";
    window.isPost = true;
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/blog/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</html>